import{R as h,r as M,g as S,h as B,M as nt,d as at,k as rt,C as X,n as ot}from"./index.1d7144b8.js";import{d as lt}from"./index.86d5d5c9.js";import{r as ct}from"./index.a906c0e7.js";import{b as ht}from"./index.d10190c4.js";import{c as dt}from"./index.7080a99e.js";import{b as V,d as Y,p as J}from"./index.409e4208.js";import{H as pt}from"./HTTPFileSystem.33aea9ff.js";import{Z as ut}from"./ZoomButtons.6b3cc4d8.js";import{a as ft,p as mt,f as gt}from"./util.5fe75924.js";import{W as vt}from"./RoadNetworkLoader.worker.655695af.js";import{D as yt,S as bt}from"./deckgl.8395df4c.js";import{ac as Z,ad as kt,_ as tt}from"./layer.0cd20467.js";import{P as St}from"./PathOffsetLayer.49496748.js";import{P as wt}from"./path-layer.4a6bc071.js";import{L as $t}from"./layer-extension.7ccbe2ef.js";import{A as q}from"./arc-layer.c708f4b2.js";import{T as K,S as Q}from"./text-layer.c8c59efd.js";import"./extends.946277fc.js";const Tt={inject:{"vs:#decl":`
attribute vec2 instanceDashArrays;
attribute float instanceDashOffsets;
varying vec2 vDashArray;
varying float vDashOffset;
`,"vs:#main-end":`
vDashArray = instanceDashArrays;
vDashOffset = instanceDashOffsets / width.x;
`,"fs:#decl":`
uniform float dashAlignMode;
uniform float capType;
uniform bool dashGapPickable;
varying vec2 vDashArray;
varying float vDashOffset;

float round(float x) {
  return floor(x + 0.5);
}
`,"fs:#main-start":`
  float solidLength = vDashArray.x;
  float gapLength = vDashArray.y;
  float unitLength = solidLength + gapLength;

  float offset;

  if (unitLength > 0.0) {
    if (dashAlignMode == 0.0) {
      offset = vDashOffset;
    } else {
      unitLength = vPathLength / round(vPathLength / unitLength);
      offset = solidLength / 2.0;
    }

    float unitOffset = mod(vPathPosition.y + offset, unitLength);

    if (gapLength > 0.0 && unitOffset > solidLength) {
      if (capType <= 0.5) {
        if (!(dashGapPickable && picking_uActive)) {
          discard;
        }
      } else {
        float distToEnd = length(vec2(
          min(unitOffset - solidLength, unitLength - unitOffset),
          vPathPosition.x
        ));
        if (distToEnd > 1.0) {
          if (!(dashGapPickable && picking_uActive)) {
            discard;
          }
        }
      }
    }
  }
`}},Ct={inject:{"vs:#decl":`
attribute float instanceOffsets;
`,"vs:DECKGL_FILTER_SIZE":`
  float offsetWidth = abs(instanceOffsets * 2.0) + 1.0;
  size *= offsetWidth;
`,"vs:#main-end":`
  float offsetWidth = abs(instanceOffsets * 2.0) + 1.0;
  float offsetDir = sign(instanceOffsets);
  vPathPosition.x = (vPathPosition.x + offsetDir) * offsetWidth - offsetDir;
  vPathPosition.y *= offsetWidth;
  vPathLength *= offsetWidth;
`,"fs:#main-start":`
  float isInside;
  isInside = step(-1.0, vPathPosition.x) * step(vPathPosition.x, 1.0);
  if (isInside == 0.0) {
    discard;
  }
`}},_t={getDashArray:{type:"accessor",value:[0,0]},getOffset:{type:"accessor",value:0},dashJustified:!1,dashGapPickable:!1};class H extends $t{constructor({dash:i=!1,offset:e=!1,highPrecisionDash:s=!1}={}){super({dash:i||s,offset:e,highPrecisionDash:s})}isEnabled(i){return"pathTesselator"in i.state}getShaders(i){if(!i.isEnabled(this))return null;let e={};return i.opts.dash&&(e=Z(e,Tt)),i.opts.offset&&(e=Z(e,Ct)),e}initializeState(i,e){const s=this.getAttributeManager();!s||!e.isEnabled(this)||(e.opts.dash&&s.addInstanced({instanceDashArrays:{size:2,accessor:"getDashArray"}}),e.opts.highPrecisionDash&&s.addInstanced({instanceDashOffsets:{size:1,accessor:"getPath",transform:e.getDashOffsets.bind(this)}}),e.opts.offset&&s.addInstanced({instanceOffsets:{size:1,accessor:"getOffset"}}))}updateState(i,e){if(!e.isEnabled(this))return;const s={};e.opts.dash&&(s.dashAlignMode=this.props.dashJustified?1:0,s.dashGapPickable=Boolean(this.props.dashGapPickable)),this.state.model.setUniforms(s)}getDashOffsets(i){const e=[0],s=this.props.positionFormat==="XY"?2:3,n=Array.isArray(i[0]),o=n?i.length:i.length/s;let l,g;for(let c=0;c<o-1;c++)l=n?i[c]:i.slice(c*s,c*s+s),l=this.projectPosition(l),c>0&&(e[c]=e[c-1]+kt(g,l)),g=l;return e}}tt(H,"defaultProps",_t);tt(H,"extensionName","PathStyleExtension");var A=function t(i,e){var s=/(^([+\-]?(?:0|[1-9]\d*)(?:\.\d*)?(?:[eE][+\-]?\d+)?)?$|^0x[0-9a-f]+$|\d+)/gi,n=/(^[ ]*|[ ]*$)/g,o=/(^([\w ]+,?[\w ]+)?[\w ]+,?[\w ]+\d+:\d+(:\d+)?[\w ]?|^\d{1,4}[\/\-]\d{1,4}[\/\-]\d{1,4}|^\w+, \w+ \d+, \d{4})/,l=/^0x[0-9a-f]+$/i,g=/^0/,c=function(P){return t.insensitive&&(""+P).toLowerCase()||""+P},d=c(i).replace(n,"")||"",m=c(e).replace(n,"")||"",p=d.replace(s,"\0$1\0").replace(/\0$/,"").replace(/^\0/,"").split("\0"),v=m.replace(s,"\0$1\0").replace(/\0$/,"").replace(/^\0/,"").split("\0"),w=parseInt(d.match(l),16)||p.length!==1&&d.match(o)&&Date.parse(d),x=parseInt(m.match(l),16)||w&&m.match(o)&&Date.parse(m)||null,$,T;if(x){if(w<x)return-1;if(w>x)return 1}for(var y=0,b=Math.max(p.length,v.length);y<b;y++){if($=!(p[y]||"").match(g)&&parseFloat(p[y])||p[y]||0,T=!(v[y]||"").match(g)&&parseFloat(v[y])||v[y]||0,isNaN($)!==isNaN(T))return isNaN($)?1:-1;if(typeof $!=typeof T&&($+="",T+=""),$<T)return-1;if($>T)return 1}return 0};function xt(t){const i=t.items.map(e=>h.createElement("li",{key:e.value+e.value[0]},h.createElement("div",{style:{width:"100%",height:`${Math.max(1,3*(1*e.value-1)+3)}px`,backgroundColor:`rgb(${e.color})`}}),e.label&&h.createElement("div",{style:{marginBottom:"0.5rem"}},e.label)));return h.createElement("div",null,h.createElement("h4",{style:{textAlign:"left",fontWeight:"bold",marginBottom:"0.5rem",fontSize:"0.8rem"}},t.title),h.createElement("p",null,t.description),h.createElement("ul",{style:{listStyle:"none",padding:0,margin:0}},i))}const O={pickup:[0,150,255],delivery:[240,0,60],service:[255,64,255]};function Dt(t){const[i,e]=M.exports.useState(S.state.viewState),[s,n]=M.exports.useState({}),[o,l]=M.exports.useState({type:"activity",pickups:[],deliveries:[]}),{dark:g,activeTab:c,numSelectedTours:d,shipments:m,depots:p,legs:v,settings:w,stopActivities:x,center:$,onClick:T}=t,{simplifyTours:y,scaleFactor:b,shipmentDotsOnTourMap:P}=w;let I=b==0?1e-6:1/Math.pow(2,(100-b)/5-6);const C=[];B[t.viewId]=()=>{e(S.state.viewState)},M.exports.useEffect(()=>{const a={},r={};m.forEach(u=>{let f=`${u.fromX}-${u.fromY}`;a[f]||(a[f]={type:"pickup",shipmentIds:[],coord:[u.fromX,u.fromY]}),a[f].shipmentIds.push(u.$id),f=`${u.toX}-${u.toY}`,r[f]||(r[f]={type:"delivery",shipmentIds:[],coord:[u.toX,u.toY]}),r[f].shipmentIds.push(u.$id)}),l({type:"activity",pickups:Object.values(a),deliveries:Object.values(r)})},[m]);function R(a){a.object?T(a.object):T(null)}function z(a){e(a),a.center=[a.longitude,a.latitude],S.commit("setMapCamera",a)}function L(a){const{object:r}=a;return r?(r==null?void 0:r.type)=="pickup"?D(a,"pickup"):(r==null?void 0:r.type)=="delivery"?D(a,"delivery"):r!=null&&r.color?et(a):(r==null?void 0:r.type)=="depot"?null:st(a):null}function D(a,r){const{object:u,x:f,y:_}=a;return h.createElement("div",{className:"tooltip",style:{backgroundColor:"#334455ee",boxShadow:"2.5px 2px 4px rgba(0,0,0,0.25)",color:"#eee",padding:"0.5rem 0.5rem",position:"absolute",opacity:.9,left:f+20,top:_+20}},h.createElement("table",{style:{maxWidth:"30rem",fontSize:"0.8rem"}},h.createElement("tbody",null,h.createElement("tr",null,h.createElement("td",{style:{textAlign:"right",paddingRight:"0.5rem",paddingTop:"0.2rem"}},r,":"),h.createElement("td",{style:{paddingTop:"0.2rem"}},u.shipmentIds.join(", "))))))}function et(a){var _,E;const{object:r,x:u,y:f}=a;return h.createElement("div",{className:"tooltip",style:{fontSize:"0.8rem",backgroundColor:"#334455ee",boxShadow:"2.5px 2px 4px rgba(0,0,0,0.25)",color:"#eee",padding:"0.5rem 0.5rem",position:"absolute",left:u+20,top:f-30}},h.createElement("b",null,(_=r==null?void 0:r.tour)==null?void 0:_.vehicleId),h.createElement("br",null),"Leg # ",1+(r==null?void 0:r.count)," ",h.createElement("br",null),"Shipments on board: ",(E=r==null?void 0:r.shipmentsOnBoard)==null?void 0:E.length," ",h.createElement("br",null),"Total size: ",r==null?void 0:r.totalSize)}function st(a){const{object:r,x:u,y:f}=a,_=r.visits.length,E=r.visits.reduce((k,F)=>k+F.pickup.length,0),W=r.visits.reduce((k,F)=>k+F.delivery.length,0),it=E+W,U={visits:_,pickups:E,deliveries:W},G=Object.keys(r).length*20+32;let N=f-30;return N+G>window.innerHeight&&(N=f-G),h.createElement("div",{className:"tooltip",style:{fontSize:"0.7rem",backgroundColor:"#334455ee",boxShadow:"2.5px 2px 4px rgba(0,0,0,0.25)",color:"#eee",padding:"0.5rem 0.5rem",position:"absolute",left:u+20,top:N}},h.createElement("table",{style:{fontSize:"0.8rem"}},h.createElement("tbody",null,Object.keys(U).map(k=>h.createElement("tr",{key:k},h.createElement("td",{style:{textAlign:"right",paddingRight:"0.5rem"}},k,":"),h.createElement("td",{style:{fontWeight:"bold"}}," ",U[k]))),it==1&&Object.keys(r.details).map(k=>h.createElement("tr",{key:k},h.createElement("td",{style:{textAlign:"right",paddingRight:"0.5rem",paddingTop:"0.2rem"}},k.slice(1),":"),h.createElement("td",{style:{paddingTop:"0.2rem"}},r.details[k]))))))}if(c=="tours"&&(C.push(new wt({id:"shipmentLocationDashedLine",data:x,getPath:a=>[a.ptFrom,a.ptTo],getColor:[128,128,128],getOffset:2,opacity:1,widthMinPixels:3,rounded:!0,shadowEnabled:!1,pickable:!1,autoHighlight:!1,highlightColor:[255,255,255],parameters:{depthTest:!1},getDashArray:[3,2],dashJustified:!0,extensions:[new H({dash:!0})]})),y?C.push(new q({id:"leg-arcs",data:v,getSourcePosition:a=>a.points[0],getTargetPosition:a=>a.points[a.points.length-1],getSourceColor:a=>a.color,getTargetColor:a=>a.color,getWidth:b?a=>a.totalSize/2:3,getHeight:.5,widthMinPixels:2,widthMaxPixels:200,widthUnits:"pixels",widthScale:I,opacity:.9,parameters:{depthTest:!1},updateTriggers:{getWidth:[b]},transitions:{getWidth:150},pickable:!0,autoHighlight:!0,highlightColor:[255,255,255],onHover:n})):C.push(new St({id:"deliveryroutes",data:v,getPath:a=>a.points,getColor:a=>a.color,getWidth:b?a=>a.totalSize:3,getOffset:2,opacity:1,widthMinPixels:3,widthMaxPixels:200,widthUnits:"pixels",widthScale:I,rounded:!0,shadowEnabled:!1,pickable:!0,autoHighlight:!0,highlightColor:[255,255,255],onHover:n,parameters:{depthTest:!1},updateTriggers:{getWidth:[b]},transitions:{getWidth:150}})),C.push(new K({id:"dest-labels",data:x,background:!0,backgroundPadding:d!==1?[2,1,2,1]:[3,2,3,1],getColor:[255,255,255],getBackgroundColor:a=>{const r=a.visits.reduce((f,_)=>f+_.pickup.length,0),u=a.visits.reduce((f,_)=>f+_.delivery.length,0);return r&&u?[0,0,255]:r?O.pickup:u?O.delivery:[240,130,0]},getPosition:a=>a.midpoint,getText:a=>a.label=="Depot"?a.label:d!==1?" ":`${a.label}`,getSize:a=>a.label=="Depot"?11:d!==1?4:11,getTextAnchor:"middle",getAlignmentBaseline:"center",opacity:1,noAlloc:!1,billboard:!0,sizeScale:1,pickable:!0,autoHighlight:!0,highlightColor:[255,255,255],onHover:n,visible:P}))),c=="shipments"){C.push(new Q({id:"deliveries",data:o.deliveries,getPosition:r=>r.coord,getColor:O.delivery,getRadius:3,opacity:.9,parameters:{depthTest:!1},pickable:!0,radiusUnits:"pixels",onHover:n})),C.push(new Q({id:"pickups",data:o.pickups,getPosition:r=>r.coord,getColor:O.pickup,getRadius:2,opacity:.9,parameters:{depthTest:!1},pickable:!0,radiusUnits:"pixels",onHover:n}));const a=m.length>1?32:255;C.push(new q({id:"shipments",data:m,getSourcePosition:r=>[r.fromX,r.fromY],getTargetPosition:r=>[r.toX,r.toY],getSourceColor:[0,228,255,a],getTargetColor:[240,0,60,224],getWidth:b?r=>parseInt(r.$size)||1:1,widthUnits:"pixels",getHeight:.5,opacity:.9,parameters:{depthTest:!1},widthScale:I,widthMinPixels:1,widthMaxPixels:100,updateTriggers:{getWidth:[b]},transitions:{getWidth:200}}))}return C.push(new K({id:"depots",data:p,background:!0,backgroundPadding:[3,2,3,1],getColor:[255,255,255],getBackgroundColor:[0,150,240],getPosition:a=>a.midpoint,getText:a=>"Depot",getTextAnchor:"middle",getAlignmentBaseline:"center",getSize:11,opacity:1,noAlloc:!1,billboard:!0,sizeScale:1,pickable:!0,autoHighlight:!0,highlightColor:[255,255,255],onHover:n})),h.createElement(yt,{layers:C,pickingRadius:3,controller:!0,getCursor:()=>"pointer",onClick:R,viewState:i,onViewStateChange:a=>z(a.viewState)},h.createElement(bt,{mapboxApiAccessToken:nt,mapStyle:S.getters.mapStyle}),L(s))}const At={messages:{en:{carriers:"Carriers",vehicles:"VEHICLES",services:"SERVICES",shipments:"SHIPMENTS",tours:"TOURS",pickup:"Pickup",delivery:"Delivery",flatten:"Simple&nbsp;tours",shipmentDots:"Show shipments",scaleSize:"Widths",scaleFactor:"Width"},de:{carriers:"Unternehmen",vehicles:"FAHRZEUGE",services:"BETRIEBE",shipments:"LIEFERUNGEN",tours:"TOUREN",pickup:"Abholung",delivery:"Lieferung"}}};A.insensitive=!0;const Pt=at({name:"CarrierPlugin",i18n:At,components:{LegendColors:xt,ToggleButton:lt.exports.ToggleButton,TourViz:Dt,ZoomButtons:ut},props:{root:{type:String,required:!0},subfolder:{type:String,required:!0},yamlConfig:String,config:Object,thumbnail:Boolean},data:()=>({linkLayerId:Math.floor(1e12*Math.random()),vizSettings:{simplifyTours:!1,scaleShipmentSizes:!0,shipmentDotsOnTourMap:!0,scaleFactor:0},vizDetails:{network:"",carriers:"",projection:"",title:"",description:"",thumbnail:"",center:null},myState:{statusMessage:"",isRunning:!1,subfolder:"",yamlConfig:"",thumbnail:!0,data:[]},searchTerm:"",searchEnabled:!1,globalState:S.state,isLoaded:!0,showHelp:!1,activeTab:"shipments",speedStops:[-10,-5,-2,-1,-.5,-.25,0,.25,.5,1,2,5,10],speed:1,legendBits:[],links:null,toggleTours:!0,toggleVehicles:!0,toggleShipments:!0,toggleServices:!0,detailContent:"",data:null,carriers:[],vehicles:[],shipments:[],shipmentLookup:{},services:[],stopActivities:[],tours:[],plans:[],shownShipments:[],shipmentIdsInTour:[],depots:[],shownDepots:[],shownLegs:[],selectedCarrier:"",selectedTours:[],selectedPlan:null,selectedPlanIndex:null,selectedShipment:null,thumbnailUrl:"url('assets/thumbnail.jpg') no-repeat;",vehicleLookup:[],vehicleLookupString:{},rgb:dt({colormap:"phase",nshades:9,format:"rba"}).map(t=>t.slice(0,3)).reverse(),dropdownIsActive:!1}),computed:{fileApi(){return new pt(this.fileSystem,S)},fileSystem(){const t=this.$store.state.svnProjects.filter(i=>i.slug===this.root);if(t.length===0)throw console.log("no such project"),Error;return t[0]},urlThumbnail(){return this.thumbnailUrl},textColor(){const t={text:"#3498db",bg:"#eeeef480"},i={text:"white",bg:"#181518aa"};return this.globalState.isDarkMode?i:t}},watch:{"$store.state.viewState"(){!B[this.linkLayerId]||B[this.linkLayerId]()},"globalState.isDarkMode"(){this.updateLegendColors()},async"globalState.authAttempts"(){console.log("AUTH CHANGED - Reload"),this.yamlConfig||this.buildRouteFromUrl(),await this.getVizDetails()}},methods:{handleSelectShipment(t){if(console.log({shipment:t}),this.selectedShipment===t){if(this.selectedShipment=null,this.shownShipments=[],!this.selectedTours.length){const i=this.carriers.filter(e=>e.$id==this.selectedCarrier);this.selectedCarrier="",this.handleSelectCarrier(i[0])}return}this.shownShipments=this.shipments.filter(i=>i.$id===t.$id),this.selectedShipment=t},processActivitiesInTour(t){const i=[];let e=0;const s={};let n=this.vehicles.filter(d=>d.$id===t.vehicleId)[0];const o=this.links[n.$depotLinkId];let l=[.5*(o[0]+o[2]),.5*(o[1]+o[3])],g=n.$depotLinkId;s[`L${n.$depotLinkId}`]={link:n.$depotLinkId,midpoint:l,visits:[{pickup:[],delivery:[],service:[]}],label:"",tour:t,details:{},ptFrom:[o[0],o[1]],ptTo:[o[2],o[3]]};for(const d of t.plan){if(!d.$shipmentId)continue;i.push(d.$shipmentId);const m=this.shipmentLookup[d.$shipmentId];if(!m)continue;const p=d.$type==="pickup"?m.$from:m.$to,v=[this.links[p][0],this.links[p][1]],w=[this.links[p][2],this.links[p][3]],x=[.5*(v[0]+w[0]),.5*(v[1]+w[1])],$=this.$t(d.$type),{from:T,fromX:y,fromY:b,to:P,toX:I,toY:C,id:R,...z}=m,L={id:m.$id,type:$,count:e++,link:p,midpoint:x,label:"",tour:t,details:z,ptFrom:v,ptTo:w};if(p==g)s[`L${p}`].visits[s[`L${p}`].visits.length-1][d.$type].push(L);else if(`L${p}`in s){const D={pickup:[],delivery:[],service:[]};D[d.$type].push(L),s[`L${p}`].visits.push(D)}else{const D={pickup:[],delivery:[],service:[]};D[d.$type].push(L),s[`L${p}`]={link:p,midpoint:x,label:"",tour:t,details:z,ptFrom:v,ptTo:w,visits:[D]}}g=p}const c=Object.values(s);for(let d=0;d<c.length;d++)c[d].label=`${d}`;return c[0].label="Depot",{shipmentIdsInTour:i,stopActivities:c}},setupDepots(){const t={};this.vehicles.forEach(i=>{const e=i.$depotLinkId;let s=this.links[e];!s||(t[e]||(t[e]={type:"depot",link:i.$depotLinkId,midpoint:[.5*(s[0]+s[2]),.5*(s[1]+s[3])],coords:this.links[i.$depotLinkId],vehicles:{}}),t[e].vehicles[i.$id]=i)}),this.depots=Object.values(t),this.shownDepots=this.depots.slice(0)},selectAllTours(){this.selectedTours=[],this.shownLegs=[],this.stopActivities=[],this.shownDepots=[],this.shownShipments=this.shipments.slice(0);for(const t of this.tours){t.legs.forEach((e,s)=>this.addRouteToMap(t,e,s++));const i=this.processActivitiesInTour(t);this.stopActivities=this.stopActivities.concat(i.stopActivities),this.setupDepots()}},async handleSelectTour(t){if(this.selectedTours.includes(t)){this.selectedTours=this.selectedTours.filter(n=>n!==t),this.shownLegs=this.shownLegs.filter(n=>n.tour!==t),this.stopActivities=this.stopActivities.filter(n=>n.tour!==t),this.selectedTours.length||this.selectAllTours();return}this.selectedTours.length||(this.selectedTours=[],this.shownLegs=[],this.stopActivities=[],this.shownDepots=[]),this.selectedTours.push(t);const{shipmentIdsInTour:i,stopActivities:e}=this.processActivitiesInTour(t);this.shipmentIdsInTour=i;let s=0;for(const n of t.legs)this.addRouteToMap(t,n,s++);this.stopActivities=this.stopActivities.concat(e)},addRouteToMap(t,i,e){const s=[[this.links[i.links[0]][0],this.links[i.links[0]][1]]];for(const n of i.links){const o=s[s.length-1],l=[this.links[n][0],this.links[n][1]];(l[0]!==o[0]||l[1]!==o[1])&&s.push(l),s.push([this.links[n][2],this.links[n][3]])}this.shownLegs=this.shownLegs.concat([{tour:t,shipmentsOnBoard:i.shipmentsOnBoard,totalSize:i.totalSize,count:e,points:s,color:this.rgb[(3+t.tourNumber)%this.rgb.length],type:"leg"}])},handleSelectCarrier(t){var s,n;if(this.dropdownIsActive=!1,!this.links)return;const i=t.$id;if(this.vehicles=[],this.shipments=[],this.services=[],this.tours=[],this.plans=[],this.shownShipments=[],this.shownDepots=[],this.selectedShipment=null,this.shipmentIdsInTour=[],this.stopActivities=[],this.shownLegs=[],this.selectedCarrier===i){this.selectedCarrier="";return}this.selectedCarrier=i;let e=t.capabilities.vehicles.vehicle||[];this.vehicles=e.sort((o,l)=>A(o,l)),this.setupDepots(),this.shipments=this.processShipments(t),(n=(s=t.services)==null?void 0:s.service)!=null&&n.length&&(this.services=t.services.service.map(o=>o.$).sort((o,l)=>A(o.$id,l.$id))),this.tours=this.processTours(t),this.shownShipments=this.shipments,this.selectAllTours()},getAllPlans(t){if(t.plan!=null){this.plans.push(t.plan),this.selectedPlan=t.plan;return}if(t.plans!=null){if(t.plans.plan.length==null){this.plans.push(t.plans.plan),this.selectedPlan=t.plans.plan;return}this.plans=t.plans.plan;for(let i=0;i<t.plans.plan.length;i++){if(t.plans.plan[i].selected=="true"){this.selectedPlan=t.plans.plan[i];break}this.selectedPlan=t.plans.plan[i]}}},processTours(t){if(this.getAllPlans(t),!this.selectPlan||!this.plans.length)return[];const i=this.selectedPlan.tour.map((e,s)=>{const n=[e.act[0]],o=new Set;for(let c=1;c<e.act.length;c++)e.leg[c-1].shipmentsOnBoard=[...o],n.push(e.leg[c-1]),n.push(e.act[c]),e.act[c].$type=="pickup"&&e.act[c].$shipmentId&&o.add(e.act[c].$shipmentId),e.act[c].$type=="delivery"&&e.act[c].$shipmentId&&o.delete(e.act[c].$shipmentId);const l=e.leg.filter(c=>c.route&&c.route.length).map(c=>{const d=c.shipmentsOnBoard.map(p=>this.shipmentLookup[p]),m=d.reduce((p,v)=>p+parseFloat((v==null?void 0:v.$size)||0),0);return{shipmentsOnBoard:d,totalSize:m,links:c.route?c.route.split(" "):[]}});return{vehicleId:e.$vehicleId,plan:n,legs:l,tourNumber:0}});return i.sort((e,s)=>A(e.vehicleId,s.vehicleId)),i.forEach((e,s)=>e.tourNumber=s),i},processShipments(t){var e,s;if(this.shipmentLookup={},!((s=(e=t.shipments)==null?void 0:e.shipment)!=null&&s.length))return[];const i=t.shipments.shipment.sort((n,o)=>A(n.$id,o.$id));try{for(const n of i)n.fromX=.5*(this.links[n.$from][0]+this.links[n.$from][2]),n.fromY=.5*(this.links[n.$from][1]+this.links[n.$from][3]),n.toX=.5*(this.links[n.$to][0]+this.links[n.$to][2]),n.toY=.5*(this.links[n.$to][1]+this.links[n.$to][3]),this.shipmentLookup[n.$id]=n}catch{}return i},buildRouteFromUrl(){const t=this.$route.params;if(!t.project||!t.pathMatch){console.log("I CANT EVEN: NO PROJECT/PARHMATCH");return}const i=1+t.pathMatch.lastIndexOf("/"),e=t.pathMatch.substring(0,i),s=t.pathMatch.substring(i);this.myState.subfolder=e,this.myState.yamlConfig=s},async getVizDetails(){var n,o;if(this.config){this.vizDetails=Object.assign({},this.config);return}if(((n=this.yamlConfig)==null?void 0:n.endsWith("yaml"))||((o=this.yamlConfig)==null?void 0:o.endsWith("yml")))try{const l=this.yamlConfig.indexOf("/")>-1?this.yamlConfig:this.subfolder+"/"+this.yamlConfig,g=await this.fileApi.getFileText(l);this.vizDetails=ht.parse(g);return}catch(l){console.log("failed");const g=l;this.fileSystem.needPassword&&g.status===401&&S.commit("requestLogin",this.fileSystem.slug);return}const t=this.myState.yamlConfig.substring(0,15+this.myState.yamlConfig.indexOf("carriers")),{files:i}=await this.fileApi.getDirectory(this.myState.subfolder);let e=this.myState.yamlConfig.replaceAll("carriers","network");if(i.indexOf(e)==-1){const l=i.filter(g=>g.indexOf("network")>-1);l.length?e=l[0]:(this.myState.statusMessage="No road network found.",e="")}this.vizDetails={network:e,carriers:this.yamlConfig,title:t,description:"",center:this.vizDetails.center,projection:"",thumbnail:""};const s="Carrier Explorer";this.$emit("title",s),this.buildThumbnail()},async setMapCenter(){let t=0,i=0,e=0;if(this.vizDetails.center)typeof this.vizDetails.center=="string"&&(this.vizDetails.center=this.vizDetails.center.split(",").map(Number)),i=this.vizDetails.center[0],e=this.vizDetails.center[1];else if(!this.vizDetails.center){if(this.data=Object.entries(this.links),!this.data.length)return;const s=this.data.length/2,n=4096;for(let o=0;o<s;o+=n)i+=this.data[o*2][1][0],e+=this.data[o*2+1][1][1],t++;i=i/t,e=e/t}i&&e&&this.$store.commit("setMapCamera",{longitude:i,latitude:e,zoom:9,bearing:0,pitch:0,jump:!1})},async buildThumbnail(){if(this.thumbnail&&this.vizDetails.thumbnail)try{const t=await this.fileApi.getFileBlob(this.myState.subfolder+"/"+this.vizDetails.thumbnail),i=await ct.arraybuffer(t),e=ft(i);e&&(this.thumbnailUrl=`center / cover no-repeat url(data:image/png;base64,${e})`)}catch(t){console.error(t)}},handleClick(t){console.log("CLICK!",t),t||this.clickedEmptyMap(),(t==null?void 0:t.type)=="depot"&&this.clickedDepot(t),(t==null?void 0:t.type)=="leg"&&this.clickedLeg(t)},clickedDepot(t){const i=Object.values(t.vehicles).map(e=>e.$id);console.log({vehiclesAtThisDepot:i}),this.selectedTours=[],this.shownShipments=[];for(const e of this.tours)i.includes(e.vehicleId)&&(this.handleSelectTour(e),this.shipmentIdsInTour.forEach(s=>{this.shownShipments.push(this.shipmentLookup[s])}))},clickedLeg(t){t!=null&&t.tour&&this.handleSelectTour(t==null?void 0:t.tour)},clickedEmptyMap(){this.selectAllTours()},updateLegendColors(){},async loadCarriers(){const t=await this.loadFileOrGzippedFile(this.vizDetails.carriers);return t?(await mt(t,{alwaysArray:["carriers.carrier","carriers.carrier.capabilities.vehicles.vehicle","carriers.carrier.plan.tour","carriers.carrier.shipments.shipment","carriers.carrier.services.service"]})).carriers.carrier.sort((s,n)=>A(s.$id,n.$id)):[]},async loadNetwork(){if(this.myState.statusMessage="Loading network...",this.vizDetails.network.indexOf(".xml.")>-1){const t=`${this.myState.subfolder}/${this.vizDetails.network}`,i=await this.fetchNetwork(t,{});i.projection=="Atlantis"&&this.$store.commit("setMapStyles",rt),this.myState.statusMessage="Building network link table";const e={};return i.linkIds.forEach((s,n)=>{e[s]=[i.source[n*2],i.source[n*2+1],i.dest[n*2],i.dest[n*2+1]]}),e}else{const t=await this.fileApi.getFileBlob(this.myState.subfolder+"/"+this.vizDetails.network),i=t?await V(t):null;let e=await Y.run(J.inflateAsync(i,{to:"string"}));return JSON.parse(e)}},async fetchNetwork(t,i){return new Promise((e,s)=>{const n=new vt;try{n.postMessage({filePath:t,fileSystem:this.fileSystem,vizDetails:i}),n.onmessage=o=>{if(o.data.promptUserForCRS){let l=prompt("Enter the coordinate reference system, e.g. EPSG:25832")||"EPSG:31468";isNaN(parseInt(l))||(l=`EPSG:${l}`),n.postMessage({crs:l});return}n.terminate(),o.data.error&&(console.error(o.data.error),S.commit("error",o.data.error),s(o.data.error)),e(o.data.links)}}catch(o){n.terminate(),console.error(o),s(o)}})},toggleLoaded(t){this.isLoaded=t},rotateColors(){localStorage.setItem("plugin/agent-animation/colorscheme",this.globalState.isDarkMode?X.DarkMode:X.LightMode)},async loadFileOrGzippedFile(t){let i=`${this.subfolder}/${t}`;try{if(i.indexOf("*")>-1||i.indexOf("?")>-1){const s=i.substring(1+i.lastIndexOf("/")),n=i.substring(0,i.lastIndexOf("/")),{files:o}=await this.fileApi.getDirectory(n),l=gt(o,s);if(l.length==0)throw Error(`No files matched "${s}"`);if(l.length>1)throw Error(`More than one file matched "${s}": ${l}`);i=`${n}/${l[0]}`}let e="";if(i.endsWith("xml"))e=await this.fileApi.getFileText(i);else if(i.endsWith("gz")){const s=await this.fileApi.getFileBlob(i),n=s?await V(s):null;e=await Y.run(J.inflateAsync(n,{to:"string"}))}return e}catch(e){S.commit("error",""+e);const s=i+": "+e;return console.error(e),this.myState.statusMessage=s,""}},selectDropdown(){this.dropdownIsActive=!this.dropdownIsActive},selectPlan(t){for(let i=0;i<this.plans.length;i++)this.plans[i].$selected="false";t.$selected="true",this.selectedPlanIndex=this.plans.indexOf(t),this.selectedTours=[],this.selectDropdown(),this.selectedPlan=t}},async mounted(){S.commit("setFullScreen",!this.thumbnail),this.myState.thumbnail=this.thumbnail,this.myState.subfolder=this.subfolder,this.yamlConfig||this.buildRouteFromUrl(),await this.getVizDetails(),!this.thumbnail&&(this.showHelp=!1,this.updateLegendColors(),this.myState.statusMessage="Loading carriers...",this.carriers=await this.loadCarriers(),await this.$nextTick(),this.links=await this.loadNetwork(),this.setMapCenter(),this.myState.statusMessage="",this.carriers.length&&this.handleSelectCarrier(this.carriers[0]))},beforeDestroy(){this.myState.isRunning=!1,S.commit("setFullScreen",!1),this.$store.commit("setFullScreen",!1)}});var Lt=function(){var t=this,i=t.$createElement,e=t._self._c||i;return e("div",{staticClass:"carrier-viewer",class:{"hide-thumbnail":!t.thumbnail},style:{background:t.urlThumbnail},attrs:{oncontextmenu:"return false"}},[e("div",{staticClass:"container-1"},[e("div",{staticClass:"main-panel"},[t.thumbnail?t._e():e("tour-viz",{staticClass:"anim",attrs:{activeTab:t.activeTab,shipments:t.shownShipments,depots:t.shownDepots,legs:t.shownLegs,stopActivities:t.stopActivities,dark:t.globalState.isDarkMode,center:t.vizDetails.center,viewId:t.linkLayerId,settings:t.vizSettings,numSelectedTours:t.selectedTours.length,onClick:t.handleClick}}),t.thumbnail?t._e():e("ZoomButtons"),t.myState.statusMessage?e("div",{staticClass:"xmessage"},[t._v(t._s(t.myState.statusMessage))]):t._e()],1),t.thumbnail?t._e():e("div",{staticClass:"right-panel",attrs:{darkMode:!0}},[t.carriers.length?e("h3",{staticStyle:{"margin-left":"0.25rem"}},[t._v(t._s(t.$t("carriers")))]):t._e(),e("div",{staticClass:"carrier-list"},t._l(t.carriers,function(s){return e("div",{key:s.$id,staticClass:"carrier",class:{selected:s.$id===t.selectedCarrier},on:{click:function(n){return t.handleSelectCarrier(s)}}},[e("div",{staticClass:"carrier-title"},[t._v(t._s(s.$id))])])}),0),e("h4",[t._v(t._s(t.selectedCarrier||"Details"))]),t.selectedCarrier?e("b-field",{staticClass:"detail-buttons",attrs:{size:"is-small"}},[e("b-radio-button",{attrs:{"native-value":"shipments",size:"is-small",type:"is-warning"},model:{value:t.activeTab,callback:function(s){t.activeTab=s},expression:"activeTab"}},[e("span",[t._v(t._s(t.$t("shipments")))])]),e("b-radio-button",{attrs:{"native-value":"tours",size:"is-small",type:"is-warning"},model:{value:t.activeTab,callback:function(s){t.activeTab=s},expression:"activeTab"}},[e("span",[t._v(t._s(t.$t("tours")))])]),e("b-radio-button",{attrs:{"native-value":"vehicles",size:"is-small",type:"is-warning"},model:{value:t.activeTab,callback:function(s){t.activeTab=s},expression:"activeTab"}},[e("span",[t._v(t._s(t.$t("vehicles")))])]),t.services.length?e("b-radio-button",{attrs:{"native-value":"services",size:"is-small",type:"is-warning"},model:{value:t.activeTab,callback:function(s){t.activeTab=s},expression:"activeTab"}},[e("span",[t._v(t._s(t.$t("services")))])]):t._e()],1):t._e(),e("div",{staticClass:"detail-area"},[t.activeTab=="shipments"?e("div",{staticClass:"shipments"},[e("span",[t._v(t._s(t.$t("shipments"))+": "+t._s(t.shipments.length))]),t._l(t.shipments,function(s,n){return e("div",{key:`${n}-${s.$id}`,staticClass:"leaf tour",class:{selected:s==t.selectedShipment,"shipment-in-tour":t.shipmentIdsInTour.includes(s.$id)},on:{click:function(o){return t.handleSelectShipment(s)}}},[t._v(t._s(`${s.$id}: ${s.$from}-${s.$to}`))])})],2):t._e(),t.activeTab=="tours"?e("div",{staticClass:"tours"},[this.plans.length>1?e("div",{staticClass:"dropdown",class:{"is-active":t.dropdownIsActive},staticStyle:{width:"100%"}},[e("div",{staticClass:"dropdown-trigger",on:{click:function(s){return t.selectDropdown()}}},[e("button",[e("span",[t._v("Plan "+t._s(t.selectedPlanIndex+1))]),t._m(0)])]),e("div",{staticClass:"dropdown-menu"},[e("div",{staticClass:"dropdown-content"},t._l(this.plans,function(s,n){return e("a",{staticClass:"dropdown-item",class:{"is-active":s.$selected=="true"},on:{click:function(o){return t.selectPlan(s)}}},[t._v("Plan "+t._s(n+1))])}),0)])]):t._e(),e("span",[t._v(t._s(t.$t("tours"))+": "+t._s(t.tours.length))]),t._l(t.tours,function(s,n){return e("div",{key:`${n}-${s.$id}`,staticClass:"leaf tour",class:{selected:t.selectedTours.includes(s)},on:{click:function(o){return t.handleSelectTour(s)}}},[t._v(t._s(`${s.vehicleId}`))])})],2):t._e(),t.activeTab=="vehicles"?e("div",{staticClass:"vehicles"},[e("span",[t._v(t._s(t.$t("vehicles"))+": "+t._s(t.vehicles.length))]),t._l(t.vehicles,function(s,n){return e("div",{key:`${n}-${s.$id}`,staticClass:"leaf tour"},[t._v(t._s(s.$id))])})],2):t._e(),t.activeTab=="services"?e("div",{staticClass:"services"},[e("span",[t._v(t._s(t.$t("services"))+": "+t._s(t.services.length))]),t._l(t.services,function(s,n){return e("div",{key:`${n}-${s.$id}`,staticClass:"leaf tour"},[t._v(t._s(`${s.$id}`))])})],2):t._e()]),e("div",{staticClass:"switchbox"},[e("div",{staticClass:"switches"},[e("p",[t._v(t._s(t.$t("scaleSize")))]),e("b-slider",{staticClass:"slider",attrs:{tooltip:!1,type:"is-link",size:"is-small"},model:{value:t.vizSettings.scaleFactor,callback:function(s){t.$set(t.vizSettings,"scaleFactor",s)},expression:"vizSettings.scaleFactor"}})],1),e("div",{staticClass:"switches"},[e("b-switch",{model:{value:t.vizSettings.shipmentDotsOnTourMap,callback:function(s){t.$set(t.vizSettings,"shipmentDotsOnTourMap",s)},expression:"vizSettings.shipmentDotsOnTourMap"}},[e("span",{domProps:{innerHTML:t._s(t.$t("shipmentDots"))}})]),e("b-switch",{model:{value:t.vizSettings.simplifyTours,callback:function(s){t.$set(t.vizSettings,"simplifyTours",s)},expression:"vizSettings.simplifyTours"}},[e("span",{domProps:{innerHTML:t._s(t.$t("flatten"))}})])],1)])],1)])])},Et=[function(){var t=this,i=t.$createElement,e=t._self._c||i;return e("span",{staticClass:"icon is-small"},[e("i",{staticClass:"fas fa-angle-down"})])}];const j={};var It=ot(Pt,Lt,Et,!1,zt,"ff522992",null,null);function zt(t){for(let i in j)this[i]=j[i]}var jt=function(){return It.exports}();export{jt as default};
//# sourceMappingURL=CarrierViewer.5754df7f.js.map
