import{e as H,V as rt,r as At,g as Q,h as ot,R as Pt,M as we,q as be,n as Le}from"./index.1d7144b8.js";import{c as Ce}from"./turf.es.943b3175.js";import{V as xe}from"./VizConfigurator.ac3cf377.js";import{Z as Fe}from"./ZoomButtons.6b3cc4d8.js";import{W as _e,D as Se,S as Oe}from"./deckgl.8395df4c.js";import{a as _t,b as St,c as Ot,M as Et,G as Tt,u as Ee}from"./layer.0cd20467.js";import{G as j}from"./index.84f8ccb6.js";import{r as Wt,s as Te,p as Ie,a as De,l as Me,t as X,b as P,c as Ae,d as Pe,e as ze,f as Re,g as je,h as ke,i as Ne,j as Be}from"./bounds.4be3f103.js";import{s as Ge,b as $e,e as Ue,f as He,g as Ye,h as Ze,i as Ve,m as We,j as qe,k as Ke,p as Xe,l as Je,n as Qe,o as tn,q as en,r as nn,t as on,u as sn,v as rn,w as an,x as cn,y as ln}from"./ColorsAndWidths.b0ff51a4.js";import{c as un,w as fn}from"./rainbow.d98e4227.js";import{c as qt,r as dn}from"./cubehelix.15b78c18.js";import{r as gn,h as It,i as hn,b as Kt,c as pn,d as mt}from"./threshold.d4cae24d.js";import{m as Xt}from"./min.4e1438e9.js";import{r as Jt,D as mn}from"./DashboardDataManager.6cb84912.js";import{C as vn,S as yn,T as wn}from"./text-layer.c8c59efd.js";import{H as bn}from"./HTTPFileSystem.33aea9ff.js";import{b as zt}from"./index.d10190c4.js";import{u as Ln}from"./util.5fe75924.js";function vt(n,e){let t,o;if(e===void 0)for(const i of n)i!=null&&(t===void 0?i>=i&&(t=o=i):(t>i&&(t=i),o<i&&(o=i)));else{let i=-1;for(let r of n)(r=e(r,++i,n))!=null&&(t===void 0?r>=r&&(t=o=r):(t>r&&(t=r),o<r&&(o=r)))}return[t,o]}var Qt={exports:{}};(function(n){(function(e,t,o){function i(s){var l=this,f=a();l.next=function(){var u=2091639*l.s0+l.c*23283064365386963e-26;return l.s0=l.s1,l.s1=l.s2,l.s2=u-(l.c=u|0)},l.c=1,l.s0=f(" "),l.s1=f(" "),l.s2=f(" "),l.s0-=f(s),l.s0<0&&(l.s0+=1),l.s1-=f(s),l.s1<0&&(l.s1+=1),l.s2-=f(s),l.s2<0&&(l.s2+=1),f=null}function r(s,l){return l.c=s.c,l.s0=s.s0,l.s1=s.s1,l.s2=s.s2,l}function c(s,l){var f=new i(s),u=l&&l.state,d=f.next;return d.int32=function(){return f.next()*4294967296|0},d.double=function(){return d()+(d()*2097152|0)*11102230246251565e-32},d.quick=d,u&&(typeof u=="object"&&r(u,f),d.state=function(){return r(f,{})}),d}function a(){var s=4022871197,l=function(f){f=String(f);for(var u=0;u<f.length;u++){s+=f.charCodeAt(u);var d=.02519603282416938*s;s=d>>>0,d-=s,d*=s,s=d>>>0,d-=s,s+=d*4294967296}return(s>>>0)*23283064365386963e-26};return l}t&&t.exports?t.exports=c:o&&o.amd?o(function(){return c}):this.alea=c})(H,n,!1)})(Qt);var te={exports:{}};(function(n){(function(e,t,o){function i(a){var s=this,l="";s.x=0,s.y=0,s.z=0,s.w=0,s.next=function(){var u=s.x^s.x<<11;return s.x=s.y,s.y=s.z,s.z=s.w,s.w^=s.w>>>19^u^u>>>8},a===(a|0)?s.x=a:l+=a;for(var f=0;f<l.length+64;f++)s.x^=l.charCodeAt(f)|0,s.next()}function r(a,s){return s.x=a.x,s.y=a.y,s.z=a.z,s.w=a.w,s}function c(a,s){var l=new i(a),f=s&&s.state,u=function(){return(l.next()>>>0)/4294967296};return u.double=function(){do var d=l.next()>>>11,g=(l.next()>>>0)/4294967296,h=(d+g)/(1<<21);while(h===0);return h},u.int32=l.next,u.quick=u,f&&(typeof f=="object"&&r(f,l),u.state=function(){return r(l,{})}),u}t&&t.exports?t.exports=c:o&&o.amd?o(function(){return c}):this.xor128=c})(H,n,!1)})(te);var ee={exports:{}};(function(n){(function(e,t,o){function i(a){var s=this,l="";s.next=function(){var u=s.x^s.x>>>2;return s.x=s.y,s.y=s.z,s.z=s.w,s.w=s.v,(s.d=s.d+362437|0)+(s.v=s.v^s.v<<4^(u^u<<1))|0},s.x=0,s.y=0,s.z=0,s.w=0,s.v=0,a===(a|0)?s.x=a:l+=a;for(var f=0;f<l.length+64;f++)s.x^=l.charCodeAt(f)|0,f==l.length&&(s.d=s.x<<10^s.x>>>4),s.next()}function r(a,s){return s.x=a.x,s.y=a.y,s.z=a.z,s.w=a.w,s.v=a.v,s.d=a.d,s}function c(a,s){var l=new i(a),f=s&&s.state,u=function(){return(l.next()>>>0)/4294967296};return u.double=function(){do var d=l.next()>>>11,g=(l.next()>>>0)/4294967296,h=(d+g)/(1<<21);while(h===0);return h},u.int32=l.next,u.quick=u,f&&(typeof f=="object"&&r(f,l),u.state=function(){return r(l,{})}),u}t&&t.exports?t.exports=c:o&&o.amd?o(function(){return c}):this.xorwow=c})(H,n,!1)})(ee);var ne={exports:{}};(function(n){(function(e,t,o){function i(a){var s=this;s.next=function(){var f=s.x,u=s.i,d,g;return d=f[u],d^=d>>>7,g=d^d<<24,d=f[u+1&7],g^=d^d>>>10,d=f[u+3&7],g^=d^d>>>3,d=f[u+4&7],g^=d^d<<7,d=f[u+7&7],d=d^d<<13,g^=d^d<<9,f[u]=g,s.i=u+1&7,g};function l(f,u){var d,g=[];if(u===(u|0))g[0]=u;else for(u=""+u,d=0;d<u.length;++d)g[d&7]=g[d&7]<<15^u.charCodeAt(d)+g[d+1&7]<<13;for(;g.length<8;)g.push(0);for(d=0;d<8&&g[d]===0;++d);for(d==8?g[7]=-1:g[d],f.x=g,f.i=0,d=256;d>0;--d)f.next()}l(s,a)}function r(a,s){return s.x=a.x.slice(),s.i=a.i,s}function c(a,s){a==null&&(a=+new Date);var l=new i(a),f=s&&s.state,u=function(){return(l.next()>>>0)/4294967296};return u.double=function(){do var d=l.next()>>>11,g=(l.next()>>>0)/4294967296,h=(d+g)/(1<<21);while(h===0);return h},u.int32=l.next,u.quick=u,f&&(f.x&&r(f,l),u.state=function(){return r(l,{})}),u}t&&t.exports?t.exports=c:o&&o.amd?o(function(){return c}):this.xorshift7=c})(H,n,!1)})(ne);var oe={exports:{}};(function(n){(function(e,t,o){function i(a){var s=this;s.next=function(){var f=s.w,u=s.X,d=s.i,g,h;return s.w=f=f+1640531527|0,h=u[d+34&127],g=u[d=d+1&127],h^=h<<13,g^=g<<17,h^=h>>>15,g^=g>>>12,h=u[d]=h^g,s.i=d,h+(f^f>>>16)|0};function l(f,u){var d,g,h,p,v,L=[],E=128;for(u===(u|0)?(g=u,u=null):(u=u+"\0",g=0,E=Math.max(E,u.length)),h=0,p=-32;p<E;++p)u&&(g^=u.charCodeAt((p+32)%u.length)),p===0&&(v=g),g^=g<<10,g^=g>>>15,g^=g<<4,g^=g>>>13,p>=0&&(v=v+1640531527|0,d=L[p&127]^=g+v,h=d==0?h+1:0);for(h>=128&&(L[(u&&u.length||0)&127]=-1),h=127,p=4*128;p>0;--p)g=L[h+34&127],d=L[h=h+1&127],g^=g<<13,d^=d<<17,g^=g>>>15,d^=d>>>12,L[h]=g^d;f.w=v,f.X=L,f.i=h}l(s,a)}function r(a,s){return s.i=a.i,s.w=a.w,s.X=a.X.slice(),s}function c(a,s){a==null&&(a=+new Date);var l=new i(a),f=s&&s.state,u=function(){return(l.next()>>>0)/4294967296};return u.double=function(){do var d=l.next()>>>11,g=(l.next()>>>0)/4294967296,h=(d+g)/(1<<21);while(h===0);return h},u.int32=l.next,u.quick=u,f&&(f.X&&r(f,l),u.state=function(){return r(l,{})}),u}t&&t.exports?t.exports=c:o&&o.amd?o(function(){return c}):this.xor4096=c})(H,n,!1)})(oe);var ie={exports:{}};(function(n){(function(e,t,o){function i(a){var s=this,l="";s.next=function(){var u=s.b,d=s.c,g=s.d,h=s.a;return u=u<<25^u>>>7^d,d=d-g|0,g=g<<24^g>>>8^h,h=h-u|0,s.b=u=u<<20^u>>>12^d,s.c=d=d-g|0,s.d=g<<16^d>>>16^h,s.a=h-u|0},s.a=0,s.b=0,s.c=-1640531527,s.d=1367130551,a===Math.floor(a)?(s.a=a/4294967296|0,s.b=a|0):l+=a;for(var f=0;f<l.length+20;f++)s.b^=l.charCodeAt(f)|0,s.next()}function r(a,s){return s.a=a.a,s.b=a.b,s.c=a.c,s.d=a.d,s}function c(a,s){var l=new i(a),f=s&&s.state,u=function(){return(l.next()>>>0)/4294967296};return u.double=function(){do var d=l.next()>>>11,g=(l.next()>>>0)/4294967296,h=(d+g)/(1<<21);while(h===0);return h},u.int32=l.next,u.quick=u,f&&(typeof f=="object"&&r(f,l),u.state=function(){return r(l,{})}),u}t&&t.exports?t.exports=c:o&&o.amd?o(function(){return c}):this.tychei=c})(H,n,!1)})(ie);var se={exports:{}};(function(n){(function(e,t,o){var i=256,r=6,c=52,a="random",s=o.pow(i,r),l=o.pow(2,c),f=l*2,u=i-1,d;function g(y,b,_){var m=[];b=b==!0?{entropy:!0}:b||{};var C=L(v(b.entropy?[y,D(t)]:y==null?E():y,3),m),O=new h(m),T=function(){for(var F=O.g(r),M=s,A=0;F<l;)F=(F+A)*i,M*=i,A=O.g(1);for(;F>=f;)F/=2,M/=2,A>>>=1;return(F+A)/M};return T.int32=function(){return O.g(4)|0},T.quick=function(){return O.g(4)/4294967296},T.double=T,L(D(O.S),t),(b.pass||_||function(F,M,A,z){return z&&(z.S&&p(z,O),F.state=function(){return p(O,{})}),A?(o[a]=F,M):F})(T,C,"global"in b?b.global:this==o,b.state)}function h(y){var b,_=y.length,m=this,C=0,O=m.i=m.j=0,T=m.S=[];for(_||(y=[_++]);C<i;)T[C]=C++;for(C=0;C<i;C++)T[C]=T[O=u&O+y[C%_]+(b=T[C])],T[O]=b;(m.g=function(F){for(var M,A=0,z=m.i,x=m.j,S=m.S;F--;)M=S[z=u&z+1],A=A*i+S[u&(S[z]=S[x=u&x+M])+(S[x]=M)];return m.i=z,m.j=x,A})(i)}function p(y,b){return b.i=y.i,b.j=y.j,b.S=y.S.slice(),b}function v(y,b){var _=[],m=typeof y,C;if(b&&m=="object")for(C in y)try{_.push(v(y[C],b-1))}catch{}return _.length?_:m=="string"?y:y+"\0"}function L(y,b){for(var _=y+"",m,C=0;C<_.length;)b[u&C]=u&(m^=b[u&C]*19)+_.charCodeAt(C++);return D(b)}function E(){try{var y;return d&&(y=d.randomBytes)?y=y(i):(y=new Uint8Array(i),(e.crypto||e.msCrypto).getRandomValues(y)),D(y)}catch{var b=e.navigator,_=b&&b.plugins;return[+new Date,e,_,e.screen,D(t)]}}function D(y){return String.fromCharCode.apply(0,y)}if(L(o.random(),t),n.exports){n.exports=g;try{d=require("crypto")}catch{}}else o["seed"+a]=g})(typeof self!="undefined"?self:H,[],Math)})(se);var Cn=Qt.exports,xn=te.exports,Fn=ee.exports,_n=ne.exports,Sn=oe.exports,On=ie.exports,Y=se.exports;Y.alea=Cn;Y.xor128=xn;Y.xorwow=Fn;Y.xorshift7=_n;Y.xor4096=Sn;Y.tychei=On;var En=Y;/**
  * vue-class-component v7.2.6
  * (c) 2015-present Evan You
  * @license MIT
  */function it(n){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?it=function(e){return typeof e}:it=function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},it(n)}function Tn(n,e,t){return e in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function In(n){return Dn(n)||Mn(n)||An()}function Dn(n){if(Array.isArray(n)){for(var e=0,t=new Array(n.length);e<n.length;e++)t[e]=n[e];return t}}function Mn(n){if(Symbol.iterator in Object(n)||Object.prototype.toString.call(n)==="[object Arguments]")return Array.from(n)}function An(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function Pn(){return typeof Reflect!="undefined"&&Reflect.defineMetadata&&Reflect.getOwnMetadataKeys}function zn(n,e){lt(n,e),Object.getOwnPropertyNames(e.prototype).forEach(function(t){lt(n.prototype,e.prototype,t)}),Object.getOwnPropertyNames(e).forEach(function(t){lt(n,e,t)})}function lt(n,e,t){var o=t?Reflect.getOwnMetadataKeys(e,t):Reflect.getOwnMetadataKeys(e);o.forEach(function(i){var r=t?Reflect.getOwnMetadata(i,e,t):Reflect.getOwnMetadata(i,e);t?Reflect.defineMetadata(i,r,n,t):Reflect.defineMetadata(i,r,n)})}var Rn={__proto__:[]},jn=Rn instanceof Array;function re(n){return function(e,t,o){var i=typeof e=="function"?e:e.constructor;i.__decorators__||(i.__decorators__=[]),typeof o!="number"&&(o=void 0),i.__decorators__.push(function(r){return n(r,t,o)})}}function kn(n){var e=it(n);return n==null||e!=="object"&&e!=="function"}function Nn(n,e){var t=e.prototype._init;e.prototype._init=function(){var r=this,c=Object.getOwnPropertyNames(n);if(n.$options.props)for(var a in n.$options.props)n.hasOwnProperty(a)||c.push(a);c.forEach(function(s){Object.defineProperty(r,s,{get:function(){return n[s]},set:function(f){n[s]=f},configurable:!0})})};var o=new e;e.prototype._init=t;var i={};return Object.keys(o).forEach(function(r){o[r]!==void 0&&(i[r]=o[r])}),i}var yt=["data","beforeCreate","created","beforeMount","mounted","beforeDestroy","destroyed","beforeUpdate","updated","activated","deactivated","render","errorCaptured","serverPrefetch"];function Rt(n){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};e.name=e.name||n._componentTag||n.name;var t=n.prototype;Object.getOwnPropertyNames(t).forEach(function(a){if(a!=="constructor"){if(yt.indexOf(a)>-1){e[a]=t[a];return}var s=Object.getOwnPropertyDescriptor(t,a);s.value!==void 0?typeof s.value=="function"?(e.methods||(e.methods={}))[a]=s.value:(e.mixins||(e.mixins=[])).push({data:function(){return Tn({},a,s.value)}}):(s.get||s.set)&&((e.computed||(e.computed={}))[a]={get:s.get,set:s.set})}}),(e.mixins||(e.mixins=[])).push({data:function(){return Nn(this,n)}});var o=n.__decorators__;o&&(o.forEach(function(a){return a(e)}),delete n.__decorators__);var i=Object.getPrototypeOf(n.prototype),r=i instanceof rt?i.constructor:rt,c=r.extend(e);return Gn(c,n,r),Pn()&&zn(c,n),c}var Bn={prototype:!0,arguments:!0,callee:!0,caller:!0};function Gn(n,e,t){Object.getOwnPropertyNames(e).forEach(function(o){if(!Bn[o]){var i=Object.getOwnPropertyDescriptor(n,o);if(!(i&&!i.configurable)){var r=Object.getOwnPropertyDescriptor(e,o);if(!jn){if(o==="cid")return;var c=Object.getOwnPropertyDescriptor(t,o);if(!kn(r.value)&&c&&c.value===r.value)return}Object.defineProperty(n,o,r)}}})}function ae(n){return typeof n=="function"?Rt(n):function(e){return Rt(e,n)}}ae.registerHooks=function(e){yt.push.apply(yt,In(e))};globalThis&&globalThis.__spreadArrays;var $n=typeof Reflect!="undefined"&&typeof Reflect.getMetadata!="undefined";function Un(n,e,t){if($n&&!Array.isArray(n)&&typeof n!="function"&&!n.hasOwnProperty("type")&&typeof n.type=="undefined"){var o=Reflect.getMetadata("design:type",e,t);o!==Object&&(n.type=o)}}function U(n){return n===void 0&&(n={}),function(e,t){Un(n,e,t),re(function(o,i){(o.props||(o.props={}))[i]=n})(e,t)}}function Hn(n,e){e===void 0&&(e={});var t=e.deep,o=t===void 0?!1:t,i=e.immediate,r=i===void 0?!1:i;return re(function(c,a){typeof c.watch!="object"&&(c.watch=Object.create(null));var s=c.watch;typeof s[n]=="object"&&!Array.isArray(s[n])?s[n]=[s[n]]:typeof s[n]=="undefined"&&(s[n]=[]),s[n].push({handler:a,deep:o,immediate:r})})}var Yn=`#define SHADER_NAME animated-flow-lines-layer-fragment-shader

precision highp float;

uniform float animationTailLength;

varying vec4 vColor;
varying float sourceToTarget;
varying vec2 uv;
                                   
void main(void) {
  geometry.uv = uv;

  gl_FragColor = vec4(vColor.xyz, vColor.w * smoothstep(1.0 - animationTailLength, 1.0, fract(sourceToTarget)));

  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`,Zn=`#define SHADER_NAME animated-flow-lines-layer-vertex-shader
#define SPEED 0.015
#define NUM_PARTS 5.0

attribute vec3 positions;
attribute vec3 instanceSourcePositions;
attribute vec3 instanceTargetPositions;
attribute vec3 instanceSourcePositions64Low;
attribute vec3 instanceTargetPositions64Low;
attribute vec4 instanceColors;
attribute vec3 instancePickingColors;
attribute float instanceWidths;
attribute float instancePickable;
attribute float instanceStaggering;

uniform float opacity;
uniform float currentTime;
uniform float thicknessUnit;
    
varying vec4 vColor;
varying float sourceToTarget;
varying vec2 uv;

// offset vector by strokeWidth pixels
// offset_direction is -1 (left) or 1 (right)
vec2 getExtrusionOffset(vec2 line_clipspace, float offset_direction, float width) {
  // normalized direction of the line
  vec2 dir_screenspace = normalize(line_clipspace * project_uViewportSize);
  // rotate by 90 degrees
  dir_screenspace = vec2(-dir_screenspace.y, dir_screenspace.x);

  return dir_screenspace * offset_direction * width / 2.0;
}

void main(void) {
  geometry.worldPosition = instanceSourcePositions;
  geometry.worldPositionAlt = instanceTargetPositions;

  // Position
  vec4 source_commonspace;
  vec4 target_commonspace;
  vec4 source = project_position_to_clipspace(instanceSourcePositions, instanceSourcePositions64Low, vec3(0.), source_commonspace);
  vec4 target = project_position_to_clipspace(instanceTargetPositions, instanceTargetPositions64Low, vec3(0.), target_commonspace);

  float widthPixels = instanceWidths * thicknessUnit;
  
  
  // linear interpolation of source & target to pick right coord
  float segmentIndex = positions.x;
  vec4 p = mix(source, target, segmentIndex);
  geometry.position = mix(source_commonspace, target_commonspace, segmentIndex);
  uv = positions.xy;
  geometry.uv = uv;
  if (instancePickable > 0.5) {
    geometry.pickingColor = instancePickingColors;
  }
  
  // extrude
  vec3 offset = vec3(
    getExtrusionOffset(target.xy - source.xy, positions.y, widthPixels),
    0.0);
  DECKGL_FILTER_SIZE(offset, geometry);
  gl_Position = p + vec4(project_pixel_size_to_clipspace(offset.xy), 0.0, 0.0);
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);

  // Color
  vColor = vec4(instanceColors.rgb, instanceColors.a * opacity) / 255.;
  DECKGL_FILTER_COLOR(vColor, geometry);

  sourceToTarget = positions.x * length(source - target) * NUM_PARTS - currentTime * SPEED + instanceStaggering; 
}
`;const Vn=[0,132,193,255],ce=1800,Wn=20,jt=ce/Wn;class st extends _t{constructor(e){super(e)}getShaders(){return super.getShaders({vs:Zn,fs:Yn,modules:[St,Ot],shaderCache:this.context.shaderCache})}initializeState(){this.getAttributeManager().addInstanced({instanceSourcePositions:{size:3,type:j.DOUBLE,transition:!0,accessor:"getSourcePosition"},instanceTargetPositions:{size:3,type:j.DOUBLE,transition:!0,accessor:"getTargetPosition"},instanceColors:{size:4,type:j.UNSIGNED_BYTE,transition:!0,accessor:"getColor",defaultValue:[0,0,0,255]},instanceWidths:{size:1,transition:!0,accessor:"getThickness",defaultValue:1},instanceStaggering:{accessor:"getStaggering",size:1,transition:!1},instancePickable:{accessor:"getPickable",size:1,transition:!1}})}getNeedsRedraw(){return!0}updateState({props:e,oldProps:t,changeFlags:o}){var i;if(super.updateState({props:e,oldProps:t,changeFlags:o}),o.extensionsChanged){const{gl:r}=this.context;(i=this.state.model)===null||i===void 0||i.delete(),this.state.model=this._getModel(r),this.getAttributeManager().invalidateAll()}}draw({uniforms:e}){const{thicknessUnit:t,animationTailLength:o}=this.props,r=Date.now()/1e3%jt/jt*ce;this.state.model.setUniforms(Object.assign(Object.assign({},e),{thicknessUnit:t*4,animationTailLength:o,currentTime:r})).draw()}_getModel(e){const t=[0,-1,0,0,1,0,1,-1,0,1,1,0];return new Et(e,Object.assign({},this.getShaders(),{id:this.props.id,geometry:new Tt({drawMode:j.TRIANGLE_STRIP,attributes:{positions:new Float32Array(t)}}),isInstanced:!0}))}}st.defaultProps={currentTime:0,animationTailLength:.7,getSourcePosition:{type:"accessor",value:n=>[0,0]},getTargetPosition:{type:"accessor",value:n=>[0,0]},getPickable:{type:"accessor",value:n=>1},getStaggering:{type:"accessor",value:(n,{index:e})=>Math.random()},getColor:{type:"accessor",value:Vn},getThickness:{type:"accessor",value:1},thicknessUnit:15*2,parameters:{depthTest:!1}};var qn=`#define SHADER_NAME flow-line-layer-fragment-shader

precision highp float;

varying vec4 vColor;
varying vec2 uv;

void main(void) {
  if (vColor.a == 0.0) {
    discard;
  }

  geometry.uv = uv;
  gl_FragColor = vColor;
  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`,Kn=`#define SHADER_NAME flow-line-layer-vertex-shader

attribute vec3 positions;
attribute vec3 normals;
attribute vec4 instanceColors;
attribute float instanceThickness;    // 0..0.5
attribute vec3 instanceSourcePositions;
attribute vec3 instanceTargetPositions;
attribute vec3 instanceSourcePositions64Low;
attribute vec3 instanceTargetPositions64Low;
attribute vec3 instancePickingColors;
attribute vec2 instanceEndpointOffsets;
attribute float instancePickable;

uniform vec4 outlineColor;
uniform float thicknessUnit;
uniform float gap;
uniform float opacity;

varying vec4 vColor;
varying vec2 uv;

void main(void) {
  geometry.worldPosition = instanceSourcePositions;
  geometry.worldPositionAlt = instanceTargetPositions;
  
  // Position
  vec4 source_commonspace;    
  vec4 target_commonspace;
  vec4 source = project_position_to_clipspace(instanceSourcePositions, instanceSourcePositions64Low, vec3(0.), source_commonspace);
  vec4 target = project_position_to_clipspace(instanceTargetPositions, instanceTargetPositions64Low, vec3(0.), target_commonspace);

  // linear interpolation of source & target to pick right coord
  float sourceOrTarget = positions.x;
  geometry.position = mix(source_commonspace, target_commonspace, sourceOrTarget);
  uv = positions.xy;
  geometry.uv = uv;
  if (instancePickable > 0.5) {
    geometry.pickingColor = instancePickingColors;
  }
  
  // set the clamp limits in pixel size 
  float lengthCommon = length(target_commonspace - source_commonspace);    
  vec2 offsetDistances = project_pixel_size(positions.yz) * thicknessUnit;
  
  vec2 limitedOffsetDistances = clamp(   
    project_pixel_size(positions.yz) * thicknessUnit,
    -lengthCommon*.8, lengthCommon*.8
  );
  float startOffsetCommon = project_pixel_size(instanceEndpointOffsets[0]);
  float endOffsetCommon = project_pixel_size(instanceEndpointOffsets[1]);
  float endpointOffset = mix(
    clamp(startOffsetCommon, 0.0, lengthCommon*.2),
    -clamp(endOffsetCommon, 0.0, lengthCommon*.2),
    positions.x
  );

  vec2 flowlineDir = normalize(target_commonspace.xy - source_commonspace.xy);
  vec2 perpendicularDir = vec2(-flowlineDir.y, flowlineDir.x);
  vec2 normalsCommon = project_pixel_size(normals.xy);
  float gapCommon = project_pixel_size(gap);
  vec3 offsetCommon = vec3(
    flowlineDir * (instanceThickness * limitedOffsetDistances[1] + normalsCommon.y + endpointOffset * 1.05) -
    perpendicularDir * (instanceThickness * limitedOffsetDistances[0] + gapCommon + normalsCommon.x),
    0.0
  );
  
  DECKGL_FILTER_SIZE(offsetCommon, geometry);
  vec4 position_commonspace = mix(source_commonspace, target_commonspace, sourceOrTarget);
  vec4 offset_commonspace = vec4(offsetCommon, 0.0);
  gl_Position = project_common_position_to_clipspace(position_commonspace + offset_commonspace);
      
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
  
  vec4 fillColor = vec4(instanceColors.rgb, instanceColors.a * opacity) / 255.;
  vColor = mix(fillColor, vec4(outlineColor.xyz, outlineColor.w * fillColor.w), normals.z);
  DECKGL_FILTER_COLOR(vColor, geometry);
}
`;const Xn=[0,132,193,255],Jn=1,kt=[1,0,0,1,2,-3,1,1,-3,1,0,0,1,1,-3,0,1,0,1,0,0,0,1,0,0,0,0];function Qn(n,e){return[-e,2*n,1,2*n,-n,1,n,-n,1,-e,2*n,1,n,-n,1,n,-n,1,-e,2*n,1,n,-n,1,-e,-n,1]}const to=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];class V extends _t{constructor(e){super(e)}getShaders(){return super.getShaders({vs:Kn,fs:qn,modules:[St,Ot],shaderCache:this.context.shaderCache})}initializeState(){const{attributeManager:e}=this.state;e.addInstanced({instanceSourcePositions:{accessor:"getSourcePosition",size:3,transition:!1,type:j.DOUBLE},instanceTargetPositions:{accessor:"getTargetPosition",size:3,transition:!1,type:j.DOUBLE},instanceThickness:{accessor:"getThickness",size:1,transition:!1},instanceEndpointOffsets:{accessor:"getEndpointOffsets",size:2,transition:!1},instanceColors:{accessor:"getColor",size:4,type:j.UNSIGNED_BYTE,transition:!1},instancePickable:{accessor:"getPickable",size:1,transition:!1}})}updateState({props:e,oldProps:t,changeFlags:o}){if(super.updateState({props:e,oldProps:t,changeFlags:o}),o.extensionsChanged){const{gl:i}=this.context;this.state.model&&this.state.model.delete(),this.setState({model:this._getModel(i)}),this.getAttributeManager().invalidateAll()}}draw({uniforms:e}){const{gl:t}=this.context,{outlineColor:o,thicknessUnit:i}=this.props;t.lineWidth(1),this.state.model.setUniforms(Object.assign(Object.assign({},e),{outlineColor:o.map(r=>r/255),thicknessUnit:i*2,gap:.5})).draw()}_getModel(e){let t=[],o=[];const{drawOutline:i,outlineThickness:r}=this.props;if(i){t=t.concat(kt);const c=r,a=Jn;o=o.concat(Qn(c,a))}return t=t.concat(kt),o=o.concat(to),new Et(e,Object.assign(Object.assign({id:this.props.id},this.getShaders()),{geometry:new Tt({drawMode:j.TRIANGLES,attributes:{positions:new Float32Array(t),normals:new Float32Array(o)}}),isInstanced:!0,shaderCache:this.context.shaderCache}))}}V.layerName="FlowLinesLayer";V.defaultProps={getSourcePosition:{type:"accessor",value:n=>[0,0]},getTargetPosition:{type:"accessor",value:n=>[0,0]},getColor:{type:"accessor",value:Xn},getThickness:{type:"accessor",value:n=>n.count},getPickable:{type:"accessor",value:n=>1},drawOutline:!0,thicknessUnit:12,outlineThickness:1,outlineColor:[255,255,255,255],parameters:{depthTest:!1}};var eo=`#define SHADER_NAME flow-circles-layer-fragment-shader
#define SOFT_OUTLINE 0.05
#define EPS 0.05
precision highp float;

uniform vec4 emptyColor;
uniform float outlineEmptyMix;

varying vec4 vColor;
varying vec2 unitPosition;
varying float unitInRadius;
varying float unitOutRadius;

float when_gt(float x, float y) {
  return max(sign(x - y), 0.0);
}

void main(void) {
  geometry.uv = unitPosition;
  float distToCenter = length(unitPosition);
  if (distToCenter > 1.0) {
    discard;
  }

  // See https://stackoverflow.com/questions/47285778
  vec4 ringColor = mix(
    emptyColor / 255., vColor,
    when_gt(unitInRadius, unitOutRadius)
  );
  vec4 outlineColor = mix(
    mix(vColor, emptyColor / 255., outlineEmptyMix),
    vColor,
    when_gt(unitInRadius, unitOutRadius)
  );
  
  float innerR = min(unitInRadius, unitOutRadius) * (1.0 - SOFT_OUTLINE);
  
  // Inner circle
  float step2 = innerR - 2.0 * EPS; 
  float step3 = innerR - EPS;
  
  // Ring
  float step4 = innerR;
  // float step5 = 1.0 - SOFT_OUTLINE - EPS;
  // float step6 = 1.0 - SOFT_OUTLINE;
  float step5 = 1.0 - 5.0 * EPS;
  float step6 = 1.0;
  
  gl_FragColor = vColor;
  gl_FragColor = mix(gl_FragColor, emptyColor / 255., smoothstep(step2, step3, distToCenter));
  gl_FragColor = mix(gl_FragColor, ringColor, smoothstep(step3, step4, distToCenter));
  gl_FragColor = mix(gl_FragColor, outlineColor, smoothstep(step5, step6, distToCenter));
  // gl_FragColor = mix(gl_FragColor, emptyColor / 255., smoothstep(step6, 1.0, distToCenter));
  gl_FragColor.a = vColor.a;
  gl_FragColor.a *= smoothstep(0.0, SOFT_OUTLINE, 1.0 - distToCenter);
  DECKGL_FILTER_COLOR(gl_FragColor, geometry);
}
`,no=`#define SHADER_NAME flow-circles-layer-vertex-shader
#define radiusScale 100

attribute vec3 positions;

attribute vec3 instancePositions;
attribute vec3 instancePositions64Low;
attribute float instanceInRadius;
attribute float instanceOutRadius;
attribute vec4 instanceColors;
attribute vec3 instancePickingColors;

uniform float opacity;
uniform vec4 emptyColor;
uniform float outlineEmptyMix;

varying vec4 vColor;
varying vec2 unitPosition;
varying float unitInRadius;
varying float unitOutRadius;

void main(void) {
  geometry.worldPosition = instancePositions;

  float outerRadiusPixels = max(instanceInRadius, instanceOutRadius);
  unitInRadius = instanceInRadius / outerRadiusPixels; 
  unitOutRadius = instanceOutRadius / outerRadiusPixels; 

  // position on the containing square in [-1, 1] space
  unitPosition = positions.xy;
  geometry.uv = unitPosition;
  geometry.pickingColor = instancePickingColors;
                                                                                                    
  // Find the center of the point and add the current vertex
  vec3 offset = positions * project_pixel_size(outerRadiusPixels);
  DECKGL_FILTER_SIZE(offset, geometry);
  gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset, geometry.position);
  DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
                            
  // Apply opacity to instance color, or return instance picking color
  vColor = vec4(instanceColors.rgb / 255., instanceColors.a / 255. * opacity);
  DECKGL_FILTER_COLOR(vColor, geometry);
}
`;const le=[0,0,0,255],oo=[255,255,255,255],io=.4;class et extends _t{constructor(e){super(e)}getShaders(){return super.getShaders({vs:no,fs:eo,modules:[St,Ot]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:j.DOUBLE,fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceInRadius:{size:1,transition:!0,accessor:"getInRadius",defaultValue:1},instanceOutRadius:{size:1,transition:!0,accessor:"getOutRadius",defaultValue:1},instanceColors:{size:4,transition:!0,type:j.UNSIGNED_BYTE,accessor:"getColor",defaultValue:le}})}updateState({props:e,oldProps:t,changeFlags:o}){if(super.updateState({props:e,oldProps:t,changeFlags:o}),o.extensionsChanged){const{gl:i}=this.context;this.state.model&&this.state.model.delete(),this.setState({model:this._getModel(i)}),this.getAttributeManager().invalidateAll()}}draw({uniforms:e}){const{emptyColor:t,outlineEmptyMix:o}=this.props;this.state.model.setUniforms(Object.assign(Object.assign({},e),{emptyColor:t,outlineEmptyMix:o})).draw()}_getModel(e){const t=[-1,-1,0,1,-1,0,1,1,0,-1,1,0];return new Et(e,Object.assign(this.getShaders(),{id:this.props.id,geometry:new Tt({drawMode:j.TRIANGLE_FAN,vertexCount:4,attributes:{positions:{size:3,value:new Float32Array(t)}}}),isInstanced:!0}))}}et.layerName="FlowCirclesLayer";et.defaultProps={getColor:{type:"accessor",value:le},emptyColor:{type:"accessor",value:oo},outlineEmptyMix:{type:"accessor",value:io},getPosition:{type:"accessor",value:n=>n.position},getInRadius:{type:"accessor",value:1},getOutRadius:{type:"accessor",value:1},parameters:{depthTest:!1}};function Dt(n){const{children:e}=n;return e&&e.length>0}function tt(n){const{zoom:e}=n;return e!==void 0}function ut(n){return n&&!!n.aggregate}var W;(function(n){n.ALL="ALL",n.INCOMING="INCOMING",n.OUTGOING="OUTGOING",n.BETWEEN="BETWEEN"})(W||(W={}));const so="#fff",ro=.4,Mt="rgba(240,240,240,0.5)",ao=[Mt,"#137CBD"],co="rgba(220,220,220,0.5)",lo=[Mt,"#f6654e"],uo=[Mt,"#00a9cc"],fo=[255,255,255,255];function go(n){return Math.round(n*255)}function Nt(n,e){const t=qt(n);if(!t)return console.warn("Invalid color: ",n),`rgba(255, 255, 255, ${e})`;const o=t.rgb();return`rgba(${o.r}, ${o.g}, ${o.b}, ${e})`}function N(n){if(Array.isArray(n))return n;const e=qt(n);if(!e)return console.warn("Invalid color: ",n),fo;const t=e.rgb();return[Math.floor(t.r),Math.floor(t.g),Math.floor(t.b),go(e.opacity)]}function k(n,e){return n?N(n):typeof e=="string"?N(e):e}const I=n=>n[n.length-1];var wt;(function(n){n.primary="#162d3c"})(wt||(wt={}));const Bt=20,Z=n=>Wt(0,Bt+1).map(e=>n(e/Bt)).reverse(),bt="rgba(240,240,240,0.5)",ho=[bt,wt.primary],po=["#f7feae","#b7e6a5","#7ccba2","#46aea0","#089099","#00718b","#045275"],mo=["#d3f2a3","#97e196","#6cc08b","#4c9b82","#217a79","#105965","#074050"],ue=["#d1eeea","#a8dbd9","#85c4c9","#68abb8","#4f90a6","#3b738f","#2a5674"],vo=ue,yo={Blues:I(Ge),BluGrn:["#c4e6c3","#96d2a4","#6dbc90","#4da284","#36877a","#266b6e","#1d4f60"],BluYl:po,BrwnYl:["#ede5cf","#e0c2a2","#d39c83","#c1766f","#a65461","#813753","#541f3f"],BuGn:I($e),BuPu:I(Ue),Burg:["#ffc6c4","#f4a3a8","#e38191","#cc607d","#ad466c","#8b3058","#672044"],BurgYl:["#fbe6c5","#f5ba98","#ee8a82","#dc7176","#c8586c","#9c3f5d","#70284a"],Cool:Z(un),DarkMint:["#d2fbd4","#a5dbc2","#7bbcb0","#559c9e","#3a7c89","#235d72","#123f5a"],Emrld:mo,GnBu:I(He),Grayish:ho,Greens:I(Ye),Greys:I(Ze),Inferno:Z(Ve),Magenta:["#f3cbd3","#eaa9bd","#dd88ac","#ca699d","#b14d8e","#91357d","#6c2167"],Magma:Z(We),Mint:["#e4f1e1","#b4d9cc","#89c0b6","#63a6a0","#448c8a","#287274","#0d585f"],Oranges:I(qe),OrRd:I(Ke),OrYel:["#ecda9a","#efc47e","#f3ad6a","#f7945d","#f97b57","#f66356","#ee4d5a"],Peach:["#fde0c5","#facba6","#f8b58b","#f59e72","#f2855d","#ef6a4c","#eb4a40"],Plasma:Z(Xe),PinkYl:["#fef6b5","#ffdd9a","#ffc285","#ffa679","#fa8a76","#f16d7a","#e15383"],PuBu:I(Je),PuBuGn:I(Qe),PuRd:I(tn),Purp:["#f3e0f7","#e4c7f1","#d1afe8","#b998dd","#9f82ce","#826dba","#63589f"],Purples:I(en),PurpOr:["#f9ddda","#f2b9c4","#e597b9","#ce78b3","#ad5fad","#834ba0","#573b88"],RdPu:I(nn),RedOr:["#f6d2a9","#f5b78e","#f19c7c","#ea8171","#dd686c","#ca5268","#b13f64"],Reds:I(on),Sunset:["#f3e79b","#fac484","#f8a07e","#eb7f86","#ce6693","#a059a0","#5c53a5"],SunsetDark:["#fcde9c","#faa476","#f0746e","#e34f6f","#dc3977","#b9257a","#7c1d6f"],Teal:ue,TealGrn:["#b0f2bc","#89e8ac","#67dba5","#4cc8a3","#38b2a3","#2c98a0","#257d98"],Viridis:Z(sn),Warm:Z(fn),YlGn:I(rn),YlGnBu:I(an),YlOrBr:I(cn),YlOrRd:I(ln)},wo="#f52020",bo="#17a5be",Lo={negative:{flows:{scheme:[bt,bo]}},positive:{flows:{scheme:[bt,wo]}},locationAreas:{outline:"rgba(92,112,128,0.5)",normal:"rgba(220,220,220,0.5)"},outlineColor:"rgb(230,233,237)"};function Co(n){return fe(!1,n.colorScheme,n.darkMode,n.fadeEnabled,n.fadeOpacityEnabled,n.fadeAmount,n.animationEnabled)}function fe(n,e,t,o,i,r,c){if(n)return Lo;let a;Array.isArray(e)?a=e:(a=e&&yo[e]||vo,t&&(a=a.slice().reverse()));{const s=Wt(0,Math.max(10,a.length)),l=s.length-1,f=Te(gn(a)).domain([0,l]);if(!o||r===0)a=s.map((u,d)=>f(d));else{const u=Ie().exponent(1.5).domain([l,0]).range([0,2*r/100]);a=s.map((d,g)=>{const h=f(g),p=u(g);if(h==null||p==null)return"#000";const v=It(h);return v.l=t?v.l-v.l*p:v.l+(100-v.l)*p,v.c=v.c-v.c*(p/4),i&&(v.opacity=v.opacity*(1-p)),v.toString()})}}return{darkMode:t,flows:{scheme:a},locationCircles:{outgoing:t?"#000":"#fff"},outlineColor:t?"#000":"rgba(255, 255, 255, 0.5)"}}function xo(n){const e=hn,t=n.length;let o=new Array(t),i=new Array(t),r=new Array(t),c=new Array(t),a,s;for(a=0;a<t;++a)s=dn(n[a]),o[a]=s.r||0,i[a]=s.g||0,r[a]=s.b||0,c[a]=s.opacity||0;return o=e(o),i=e(i),r=e(r),c=e(c),function(l){return s.r=o(l),s.g=i(l),s.b=r(l),s.opacity=c(l),s+""}}function ft(n,e,t){const o=De(xo(e)).exponent(t?.5:.3333333333333333).domain(n);return i=>N(o(i))}function Fo(n,e,t){const o=e?e[0]:0,i=e?e[1]:0;if(de(n)){const c=ft([0,i],n.positive.flows.scheme,t),a=ft([0,o],n.negative.flows.scheme,t);return s=>s>=0?c(s):a(s)}const r=ft([0,i||0],n.flows.scheme,t);return c=>r(c)}function _o(n){return n.positive!==void 0}function de(n){return n.positive!==void 0}function So(n,e){const t=n&&n.normal||co,o=It(t),i=N(t);return{normal:i,connected:k(n&&n.connected,i),highlighted:k(n&&n.highlighted,Nt(o[e?"brighter":"darker"](1).toString(),.5)),selected:k(n&&n.selected,Nt(o[e?"brighter":"darker"](2).toString(),.8)),outline:k(n&&n.outline,N(o[e?"brighter":"darker"](4).toString()))}}function Lt(n,e,t){var o,i,r;const c=n&&n.flows&&n.flows.scheme||e,a=It(c[c.length-1]),s=k(n&&n.flows&&n.flows.highlighted,N(a[t?"brighter":"darker"](.7).toString())),l=k((o=n==null?void 0:n.locationCircles)===null||o===void 0?void 0:o.empty,t?"#000":"#fff"),f=k(n&&n.locationCircles&&n.locationCircles.inner,a.toString());return{flows:{scheme:c,highlighted:s},locationCircles:{inner:f,outgoing:k(n&&n.locationCircles&&n.locationCircles.outgoing,t?"#000":"#fff"),incoming:k(n&&n.locationCircles&&n.locationCircles.incoming,a[t?"brighter":"darker"](1.25).toString()),highlighted:k(n&&n.locationCircles&&n.locationCircles.highlighted,s),empty:l,outlineEmptyMix:(r=(i=n==null?void 0:n.locationCircles)===null||i===void 0?void 0:i.outlineEmptyMix)!==null&&r!==void 0?r:.4}}}function ge(n){const e=!!(n&&n.darkMode);return{darkMode:e,locationAreas:So(n&&n.locationAreas,e),outlineColor:N(n&&n.outlineColor||so),dimmedOpacity:n&&n.dimmedOpacity!=null?n.dimmedOpacity:ro}}function Oo(n){const e=ge(n);return Object.assign(Object.assign({},e),Lt(n,ao,e.darkMode))}function Eo(n){const e=ge(n);return Object.assign(Object.assign({},e),{positive:Lt(n&&n.positive,lo,e.darkMode),negative:Lt(n&&n.negative,uo,e.darkMode)})}function Ct(n,e,t,o,i,r){if(i-o<=t)return;const c=o+i>>1;he(n,e,c,o,i,r%2),Ct(n,e,t,o,c-1,r+1),Ct(n,e,t,c+1,i,r+1)}function he(n,e,t,o,i,r){for(;i>o;){if(i-o>600){const l=i-o+1,f=t-o+1,u=Math.log(l),d=.5*Math.exp(2*u/3),g=.5*Math.sqrt(u*d*(l-d)/l)*(f-l/2<0?-1:1),h=Math.max(o,Math.floor(t-f*d/l+g)),p=Math.min(i,Math.floor(t+(l-f)*d/l+g));he(n,e,t,h,p,r)}const c=e[2*t+r];let a=o,s=i;for(J(n,e,o,t),e[2*i+r]>c&&J(n,e,o,i);a<s;){for(J(n,e,a,s),a++,s--;e[2*a+r]<c;)a++;for(;e[2*s+r]>c;)s--}e[2*o+r]===c?J(n,e,o,s):(s++,J(n,e,s,i)),s<=t&&(o=s+1),t<=s&&(i=s-1)}}function J(n,e,t,o){dt(n,t,o),dt(e,2*t,2*o),dt(e,2*t+1,2*o+1)}function dt(n,e,t){const o=n[e];n[e]=n[t],n[t]=o}function To(n,e,t,o,i,r,c){const a=[0,n.length-1,0],s=[];let l,f;for(;a.length;){const u=a.pop(),d=a.pop(),g=a.pop();if(d-g<=c){for(let v=g;v<=d;v++)l=e[2*v],f=e[2*v+1],l>=t&&l<=i&&f>=o&&f<=r&&s.push(n[v]);continue}const h=Math.floor((g+d)/2);l=e[2*h],f=e[2*h+1],l>=t&&l<=i&&f>=o&&f<=r&&s.push(n[h]);const p=(u+1)%2;(u===0?t<=l:o<=f)&&(a.push(g),a.push(h-1),a.push(p)),(u===0?i>=l:r>=f)&&(a.push(h+1),a.push(d),a.push(p))}return s}function Io(n,e,t,o,i,r){const c=[0,n.length-1,0],a=[],s=i*i;for(;c.length;){const l=c.pop(),f=c.pop(),u=c.pop();if(f-u<=r){for(let v=u;v<=f;v++)Gt(e[2*v],e[2*v+1],t,o)<=s&&a.push(n[v]);continue}const d=Math.floor((u+f)/2),g=e[2*d],h=e[2*d+1];Gt(g,h,t,o)<=s&&a.push(n[d]);const p=(l+1)%2;(l===0?t-i<=g:o-i<=h)&&(c.push(u),c.push(d-1),c.push(p)),(l===0?t+i>=g:o+i>=h)&&(c.push(d+1),c.push(f),c.push(p))}return a}function Gt(n,e,t,o){const i=n-t,r=e-o;return i*i+r*r}const Do=n=>n[0],Mo=n=>n[1];class xt{constructor(e,t=Do,o=Mo,i=64,r=Float64Array){this.nodeSize=i,this.points=e;const c=e.length<65536?Uint16Array:Uint32Array,a=this.ids=new c(e.length),s=this.coords=new r(e.length*2);for(let l=0;l<e.length;l++)a[l]=l,s[2*l]=t(e[l]),s[2*l+1]=o(e[l]);Ct(a,s,i,0,a.length-1,0)}range(e,t,o,i){return To(this.ids,this.coords,e,t,o,i,this.nodeSize)}within(e,t,o){return Io(this.ids,this.coords,e,t,o,this.nodeSize)}}var at="NOT_FOUND";function Ao(n){var e;return{get:function(o){return e&&n(e.key,o)?e.value:at},put:function(o,i){e={key:o,value:i}},getEntries:function(){return e?[e]:[]},clear:function(){e=void 0}}}function Po(n,e){var t=[];function o(a){var s=t.findIndex(function(f){return e(a,f.key)});if(s>-1){var l=t[s];return s>0&&(t.splice(s,1),t.unshift(l)),l.value}return at}function i(a,s){o(a)===at&&(t.unshift({key:a,value:s}),t.length>n&&t.pop())}function r(){return t}function c(){t=[]}return{get:o,put:i,getEntries:r,clear:c}}var zo=function(e,t){return e===t};function Ro(n){return function(t,o){if(t===null||o===null||t.length!==o.length)return!1;for(var i=t.length,r=0;r<i;r++)if(!n(t[r],o[r]))return!1;return!0}}function pe(n,e){var t=typeof e=="object"?e:{equalityCheck:e},o=t.equalityCheck,i=o===void 0?zo:o,r=t.maxSize,c=r===void 0?1:r,a=t.resultEqualityCheck,s=Ro(i),l=c===1?Ao(s):Po(c,s);function f(){var u=l.get(arguments);if(u===at){if(u=n.apply(null,arguments),a){var d=l.getEntries(),g=d.find(function(h){return a(h.value,u)});g&&(u=g.value)}l.put(arguments,u)}return u}return f.clearCache=function(){return l.clear()},f}function jo(n){var e=Array.isArray(n[0])?n[0]:n;if(!e.every(function(o){return typeof o=="function"})){var t=e.map(function(o){return typeof o=="function"?"function "+(o.name||"unnamed")+"()":typeof o}).join(", ");throw new Error("createSelector expects all input-selectors to be functions, but received the following types: ["+t+"]")}return e}function me(n){for(var e=arguments.length,t=new Array(e>1?e-1:0),o=1;o<e;o++)t[o-1]=arguments[o];var i=function(){for(var c=arguments.length,a=new Array(c),s=0;s<c;s++)a[s]=arguments[s];var l=0,f,u={memoizeOptions:void 0},d=a.pop();if(typeof d=="object"&&(u=d,d=a.pop()),typeof d!="function")throw new Error("createSelector expects an output function after the inputs, but received: ["+typeof d+"]");var g=u,h=g.memoizeOptions,p=h===void 0?t:h,v=Array.isArray(p)?p:[p],L=jo(a),E=n.apply(void 0,[function(){return l++,d.apply(null,arguments)}].concat(v)),D=n(function(){for(var b=[],_=L.length,m=0;m<_;m++)b.push(L[m].apply(null,arguments));return f=E.apply(null,b),f});return Object.assign(D,{resultFunc:d,memoizedResultFunc:E,dependencies:L,lastResult:function(){return f},recomputations:function(){return l},resetRecomputations:function(){return l=0}}),D};return i}var w=me(pe);const ko={minZoom:0,maxZoom:16,radius:40,extent:512,nodeSize:64,makeClusterName:(n,e)=>{},makeClusterId:n=>`{[${n}]}`};function No(n){const{index:e}=n;return e!=null}function ve(n){const{id:e}=n;return e!=null}function Bo(n,e,t,o){const{getLocationLon:i,getLocationLat:r,getLocationId:c}=e,a=Object.assign(Object.assign({},ko),o),{minZoom:s,maxZoom:l,nodeSize:f,makeClusterName:u,makeClusterId:d}=a,g=new Array(l+1);let h=new Array,p=0;for(const m of n){const C=i(m),O=r(m);h.push({x:Yo(C),y:Zo(O),weight:t(c(m)),zoom:1/0,index:p,parentId:-1,location:m}),p++}g[l+1]=new xt(h,$t,Ut,f,Float32Array);let v=l+1;for(let m=l;m>=s;m--){const C=$o(h,m,g[v],a);C.length===h.length?(g[m]=g[v],g[v]=void 0,v=m,h=C):(v=m,h=C,g[m]=new xt(h,$t,Ut,f,Float32Array))}if(g.length===0)return[];const L=g.map(m=>m==null?void 0:m.points.length),E=Xt(L.filter(m=>m>0)),D=Vo(n,e);let y=L.indexOf(D);D<p&&(y++,y<l+1&&(g[y]=g[l+1],g[l+1]=void 0));const b=Math.min(y,L.lastIndexOf(E)),_=new Array;v=NaN;for(let m=y;m>=b;m--){let C;const O=g[m];if(!O)continue;m<y&&(C=Jt(g[v].points,F=>F.map(M=>M.id?d(M.id):c(M.location)),F=>F.parentId));const T=[];for(const F of O.points){const{x:M,y:A,numPoints:z,location:x}=F;if(No(F))T.push({id:c(x),zoom:m,lat:r(x),lon:i(x)});else if(ve(F)){const{id:S}=F,K=C&&C.get(S);if(!K)throw new Error(`Cluster ${S} doesn't have children`);T.push({id:d(S),name:u(S,z),zoom:m,lat:Ho(A),lon:Uo(M),children:K})}}_.push({zoom:m,nodes:T}),v=m}return _}function Go(n,e,t,o,i){return{x:n,y:e,zoom:1/0,id:t,parentId:-1,numPoints:o,weight:i}}function $o(n,e,t,o){const i=[],{radius:r,extent:c}=o,a=r/(c*Math.pow(2,e));for(let s=0;s<n.length;s++){const l=n[s];if(l.zoom<=e)continue;l.zoom=e;const f=t.within(l.x,l.y,a);let u=l.weight||1,d=ve(l)?l.numPoints:1,g=l.x*u,h=l.y*u;const p=(s<<5)+(e+1);for(const v of f){const L=t.points[v];if(L.zoom<=e)continue;L.zoom=e;const E=L.weight||1,D=L.numPoints||1;g+=L.x*E,h+=L.y*E,u+=E,d+=D,L.parentId=p}d===1?i.push(l):(l.parentId=p,i.push(Go(g/u,h/u,p,d,u)))}return i}function Uo(n){return(n-.5)*360}function Ho(n){const e=(180-n*360)*Math.PI/180;return 360*Math.atan(Math.exp(e))/Math.PI-90}function Yo(n){return n/360+.5}function Zo(n){const e=Math.sin(n*Math.PI/180),t=.5-.25*Math.log((1+e)/(1-e))/Math.PI;return t<0?0:t>1?1:t}function $t(n){return n.x}function Ut(n){return n.y}function Vo(n,e){const{getLocationLon:t,getLocationLat:o}=e,i=new Map;let r=0;for(const a of n){const s=t(a),l=o(a),f=`${s},${l}`,u=i.get(f);i.set(f,u?u+1:1),r++}let c=0;for(const[a,s]of i)s>1&&c++;return r-c}function Wo(n){const e=new Map,t=new Map,o=new Map;for(const{zoom:u,nodes:d}of n){e.set(u,d);for(const g of d)if(Dt(g))t.set(g.id,g);else{const{id:h}=g,p=o.get(h);(p==null||p>u)&&o.set(h,u)}}const[i,r]=vt(n,u=>u.zoom);if(i==null||r==null)throw new Error("Could not determine minZoom or maxZoom");const c=new Map;for(const u of t.values()){const{zoom:d}=u;let g=c.get(d);g||(g=new Map,c.set(d,g)),a(u,h=>{g==null||g.set(h,u)})}function a(u,d){for(const g of u.children){const h=t.get(g);h?a(h,d):d(g)}}const s=(u,d=r)=>{const g=[],h=(p,v)=>{if(d>p.zoom)for(const L of p.children){const E=t.get(L);E?h(E,v):v.push(L)}else v.push(p.id)};return h(u,g),g};function l(u,d){const g=c.get(d);if(!g)return;const h=g.get(u);return h?h.id:void 0}return{availableZoomLevels:n.map(u=>+u.zoom).sort((u,d)=>Kt(u,d)),getClusterNodesFor:u=>{if(u!==void 0)return e.get(u)},getClusterById:u=>t.get(u),getMinZoomForLocation:u=>o.get(u)||i,expandCluster:s,findClusterFor:l,aggregateFlows:(u,d,{getFlowOriginId:g,getFlowDestId:h,getFlowMagnitude:p},v={})=>{if(d>r)return u;const L=[],E=new Map,D=(b,_)=>`${b}:${_}`,{flowCountsMapReduce:y={map:p,reduce:(b,_)=>(b||0)+_}}=v;for(const b of u){const _=g(b),m=h(b),C=l(_,d)||_,O=l(m,d)||m,T=D(C,O);if(C===_&&O===m)L.push(b);else{let F=E.get(T);F?F.count=y.reduce(F.count,y.map(b)):(F={origin:C,dest:O,count:y.map(b),aggregate:!0},L.push(F),E.set(T,F))}}return L}}}function qo(n,{getFlowOriginId:e,getFlowDestId:t,getFlowMagnitude:o}){const i={incoming:new Map,outgoing:new Map};for(const r of n){const c=e(r),a=t(r),s=o(r);i.incoming.set(a,(i.incoming.get(a)||0)+s),i.outgoing.set(c,(i.outgoing.get(c)||0)+s)}return r=>Math.max(Math.abs(i.incoming.get(r)||0),Math.abs(i.outgoing.get(r)||0))}function Ko(n,e){if(!n.length)throw new Error("No available zoom levels");return n[Math.min(pn(n,Math.floor(e)),n.length-1)]}class Ft{constructor(e){this.getLocationId=t=>tt(t)?t.id:this.accessors.getLocationId(t),this.getLocationName=t=>{let o;return tt(t)&&Dt(t)?o=t.name:this.accessors.getLocationName&&(o=this.accessors.getLocationName(t)),o||(o=`${this.getLocationId(t)}`),o},this.getLocationLat=t=>tt(t)?t.lat:this.accessors.getLocationLat(t),this.getLocationLon=t=>tt(t)?t.lon:this.accessors.getLocationLon(t),this.getFlowOriginId=t=>ut(t)?t.origin:this.accessors.getFlowOriginId(t),this.getFlowDestId=t=>ut(t)?t.dest:this.accessors.getFlowDestId(t),this.getFlowMagnitude=t=>ut(t)?t.count:this.accessors.getFlowMagnitude(t),this.getFlowTime=t=>{const{getFlowTime:o}=this.accessors;return o?o(t):void 0},this.accessors=e}setAccessors(e){this.accessors=e}getFlowmapDataAccessors(){return this.accessors}}const Xo=(n,e=0)=>{const t=e,o=new _e(Object.assign(Object.assign({},n),{width:n.width+t*2,height:n.height+t*2})).getBounds();return[o[0][0],o[0][1],o[1][0],o[1][1]]},Jo=n=>{if(!!n)return Me().range([.025,.5]).domain([0,Math.max.apply(null,n.map(e=>Math.abs(e||0)))])};function Qo(n,e,t,o,i){const{getLocationId:r,getLocationName:c,getLocationClusterName:a}=o,s=l=>{const f=t.get(l);return f?c?c(f):r(f)||l:`"${l}"`};for(const l of e)for(const f of l.nodes)if(Dt(f)){const u=n.expandCluster(f);if(u.sort((d,g)=>mt(i(d),i(g))),a)f.name=a(u);else{const d=u[0],g=u.length===2?u[1]:void 0;f.name=`"${s(d)}" and ${g?`"${s(g)}"`:`${u.length-1} others`}`}}else f.name=s(f.id)}X("%Y-%m-%d"),X("%Y-%m-%d %H:%M"),X("%Y-%m-%d %H:%M:%S"),X("%Y"),X("%Y-%m");var $;(function(n){n.SECOND="SECOND",n.MINUTE="MINUTE",n.HOUR="HOUR",n.DAY="DAY",n.MONTH="MONTH",n.YEAR="YEAR"})($||($={}));P(".%L");const ti=P(":%S"),ei=P("%I:%M"),ni=P("%I %p"),oi=P("%a %d");P("%b %d");const ii=P("%b"),si=P("%Y"),nt=[{order:0,key:$.SECOND,interval:Ae,format:ti,formatFull:P("%Y-%m-%d %H:%M:%S")},{order:1,key:$.MINUTE,interval:Pe,format:ei,formatFull:P("%Y-%m-%d %H:%M")},{order:2,key:$.HOUR,interval:ze,format:ni,formatFull:P("%a %d %b %Y, %I %p")},{order:3,key:$.DAY,interval:Re,format:oi,formatFull:P("%a %d %b %Y")},{order:4,key:$.MONTH,interval:je,format:ii,formatFull:P("%b %Y")},{order:5,key:$.YEAR,interval:ke,format:si,formatFull:P("%Y")}];function Ht(n){return nt.find(e=>e.key===n)}function ri(n){return nt.find(e=>e.order===n)}function ai(n){let e;for(const t of nt){const{interval:o}=t;if(o(n)<n)return e||t;e=t}return nt[nt.length-1]}const ci=20;class li{constructor(e){this.getFlowsFromProps=(t,o)=>o.flows,this.getLocationsFromProps=(t,o)=>o.locations,this.getClusterLevelsFromProps=(t,o)=>o.clusterLevels,this.getMaxTopFlowsDisplayNum=(t,o)=>t.settings.maxTopFlowsDisplayNum,this.getSelectedLocations=(t,o)=>{var i;return(i=t.filter)===null||i===void 0?void 0:i.selectedLocations},this.getLocationFilterMode=(t,o)=>{var i;return(i=t.filter)===null||i===void 0?void 0:i.locationFilterMode},this.getClusteringEnabled=(t,o)=>t.settings.clusteringEnabled,this.getLocationTotalsEnabled=(t,o)=>t.settings.locationTotalsEnabled,this.getLocationLabelsEnabled=(t,o)=>t.settings.locationLabelsEnabled,this.getZoom=(t,o)=>t.viewport.zoom,this.getViewport=(t,o)=>t.viewport,this.getSelectedTimeRange=(t,o)=>{var i;return(i=t.filter)===null||i===void 0?void 0:i.selectedTimeRange},this.getColorScheme=(t,o)=>t.settings.colorScheme,this.getDarkMode=(t,o)=>t.settings.darkMode,this.getFadeEnabled=(t,o)=>t.settings.fadeEnabled,this.getFadeOpacityEnabled=(t,o)=>t.settings.fadeOpacityEnabled,this.getFadeAmount=(t,o)=>t.settings.fadeAmount,this.getAnimate=(t,o)=>t.settings.animationEnabled,this.getInvalidLocationIds=w(this.getLocationsFromProps,t=>{if(!t)return;const o=[];for(const i of t){const r=this.accessors.getLocationId(i),c=this.accessors.getLocationLon(i),a=this.accessors.getLocationLat(i);(!(-90<=a&&a<=90)||!(-180<=c&&c<=180))&&o.push(r)}return o.length>0?o:void 0}),this.getLocations=w(this.getLocationsFromProps,this.getInvalidLocationIds,(t,o)=>{if(!t)return;if(!o||o.length===0)return t;const i=new Set(o),r=[];for(const c of t){const a=this.accessors.getLocationId(c);i.has(a)||r.push(c)}return r}),this.getLocationIds=w(this.getLocations,t=>{if(!t)return;const o=new Set;for(const i of t)o.add(this.accessors.getLocationId(i));return o}),this.getSelectedLocationsSet=w(this.getSelectedLocations,t=>t&&t.length>0?new Set(t):void 0),this.getSortedFlowsForKnownLocations=w(this.getFlowsFromProps,this.getLocationIds,(t,o)=>{if(!o||!t)return;const i=[];for(const r of t){const c=this.accessors.getFlowOriginId(r),a=this.accessors.getFlowDestId(r);o.has(c)&&o.has(a)&&i.push(r)}return i.sort((r,c)=>mt(Math.abs(this.accessors.getFlowMagnitude(r)),Math.abs(this.accessors.getFlowMagnitude(c))))}),this.getActualTimeExtent=w(this.getSortedFlowsForKnownLocations,t=>{if(!t)return;let o=null,i=null;for(const r of t){const c=this.accessors.getFlowTime(r);c&&((o==null||o>c)&&(o=c),(i==null||i<c)&&(i=c))}if(!(!o||!i))return[o,i]}),this.getTimeGranularityKey=w(this.getSortedFlowsForKnownLocations,this.getActualTimeExtent,(t,o)=>{if(!t||!o)return;const i=Xt(t,c=>{const a=this.accessors.getFlowTime(c);return a?ai(a).order:null});if(i==null)return;const r=ri(i);return r?r.key:void 0}),this.getTimeExtent=w(this.getActualTimeExtent,this.getTimeGranularityKey,(t,o)=>{const i=o?Ht(o):void 0;if(!t||!(i!=null&&i.interval))return;const{interval:r}=i;return[t[0],r.offset(r.floor(t[1]),1)]}),this.getSortedFlowsForKnownLocationsFilteredByTime=w(this.getSortedFlowsForKnownLocations,this.getTimeExtent,this.getSelectedTimeRange,(t,o,i)=>{if(!!t)return!o||!i||o[0]===i[0]&&o[1]===i[1]?t:t.filter(r=>{const c=this.accessors.getFlowTime(r);return c&&i[0]<=c&&c<i[1]})}),this.getLocationsHavingFlows=w(this.getSortedFlowsForKnownLocations,this.getLocations,(t,o)=>{if(!o||!t)return o;const i=new Set;for(const c of t)i.add(this.accessors.getFlowOriginId(c)),i.add(this.accessors.getFlowDestId(c));const r=[];for(const c of o)i.has(this.accessors.getLocationId(c))&&r.push(c);return r}),this.getLocationsById=w(this.getLocationsHavingFlows,t=>{if(!t)return;const o=new Map;for(const i of t)o.set(this.accessors.getLocationId(i),i);return o}),this.getLocationWeightGetter=w(this.getSortedFlowsForKnownLocations,t=>t?qo(t,this.accessors.getFlowmapDataAccessors()):void 0),this.getClusterLevels=w(this.getClusterLevelsFromProps,this.getLocationsHavingFlows,this.getLocationWeightGetter,(t,o,i)=>t||(!o||!i?void 0:Bo(o,this.accessors.getFlowmapDataAccessors(),i,{maxZoom:ci}))),this.getClusterIndex=w(this.getLocationsById,this.getLocationWeightGetter,this.getClusterLevels,(t,o,i)=>{if(!t||!o||!i)return;const r=Wo(i);return Qo(r,i,t,this.accessors.getFlowmapDataAccessors(),o),r}),this.getAvailableClusterZoomLevels=w(this.getClusterIndex,this.getSelectedLocations,(t,o)=>{if(!t)return;let i=Number.POSITIVE_INFINITY,r=Number.NEGATIVE_INFINITY;const c=a=>{const s=t.getClusterById(a);if(s)r=Math.max(r,s.zoom),i=Math.min(i,s.zoom);else{const l=t.getMinZoomForLocation(a);r=Math.max(r,l)}};if(o)for(const a of o)c(a);return t.availableZoomLevels.filter(a=>r<=a&&a<=i)}),this._getClusterZoom=w(this.getClusterIndex,this.getZoom,this.getAvailableClusterZoomLevels,(t,o,i)=>!t||!i||o==null?void 0:Ko(i,o)),this.getClusterZoom=(t,o)=>{const{settings:i}=t;if(!!i.clusteringEnabled)return i.clusteringAuto||i.clusteringLevel==null?this._getClusterZoom(t,o):i.clusteringLevel},this.getLocationsForSearchBox=w(this.getClusteringEnabled,this.getLocationsHavingFlows,this.getSelectedLocations,this.getClusterZoom,this.getClusterIndex,(t,o,i,r,c)=>{if(!o)return;let a=Array.from(o);if(c&&i){const s=[];for(const l of i){const f=c.getClusterById(l);f&&!a.find(u=>(tt(u)?u.id:this.accessors.getLocationId(u))===l)&&s.push(f)}s.length>0&&(a=a.concat(s))}return a}),this.getDiffMode=w(this.getFlowsFromProps,t=>{if(t){for(const o of t)if(this.accessors.getFlowMagnitude(o)<0)return!0}return!1}),this._getFlowmapColors=w(this.getDiffMode,this.getColorScheme,this.getDarkMode,this.getFadeEnabled,this.getFadeOpacityEnabled,this.getFadeAmount,this.getAnimate,fe),this.getFlowmapColorsRGBA=w(this._getFlowmapColors,t=>_o(t)?Eo(t):Oo(t)),this.getUnknownLocations=w(this.getLocationIds,this.getFlowsFromProps,this.getSortedFlowsForKnownLocations,(t,o,i)=>{if(!t||!o||i)return;const r=new Set;for(const c of o)t.has(this.accessors.getFlowOriginId(c))||r.add(this.accessors.getFlowOriginId(c)),t.has(this.accessors.getFlowDestId(c))||r.add(this.accessors.getFlowDestId(c));return r}),this.getSortedAggregatedFilteredFlows=w(this.getClusterIndex,this.getClusteringEnabled,this.getSortedFlowsForKnownLocationsFilteredByTime,this.getClusterZoom,this.getTimeExtent,(t,o,i,r,c)=>{if(!i)return;let a;return o&&t&&r!=null?a=t.aggregateFlows(i,r,this.accessors.getFlowmapDataAccessors()):a=ui(i,this.accessors.getFlowmapDataAccessors()),a.sort((s,l)=>mt(Math.abs(this.accessors.getFlowMagnitude(s)),Math.abs(this.accessors.getFlowMagnitude(l)))),a}),this.getExpandedSelectedLocationsSet=w(this.getClusteringEnabled,this.getSelectedLocationsSet,this.getClusterIndex,(t,o,i)=>{if(!o||!i)return o;const r=new Set;for(const c of o){const a=i.getClusterById(c);if(a){const s=i.expandCluster(a);for(const l of s)r.add(l)}else r.add(c)}return r}),this.getTotalCountsByTime=w(this.getSortedFlowsForKnownLocations,this.getTimeGranularityKey,this.getTimeExtent,this.getExpandedSelectedLocationsSet,this.getLocationFilterMode,(t,o,i,r,c)=>{const a=o?Ht(o):void 0;if(!t||!a||!i)return;const s=t.reduce((l,f)=>{var u;if(this.isFlowInSelection(f,r,c)){const d=a.interval(this.accessors.getFlowTime(f)).getTime();l.set(d,((u=l.get(d))!==null&&u!==void 0?u:0)+this.accessors.getFlowMagnitude(f))}return l},new Map);return Array.from(s.entries()).map(([l,f])=>({time:new Date(l),count:f}))}),this.getMaxLocationCircleSize=w(this.getLocationTotalsEnabled,t=>t?17:1),this.getViewportBoundingBox=w(this.getViewport,this.getMaxLocationCircleSize,Xo),this.getLocationsForZoom=w(this.getClusteringEnabled,this.getLocationsHavingFlows,this.getClusterIndex,this.getClusterZoom,(t,o,i,r)=>t&&i?i.getClusterNodesFor(r):o),this.getLocationTotals=w(this.getLocationsForZoom,this.getSortedAggregatedFilteredFlows,this.getSelectedLocationsSet,this.getLocationFilterMode,(t,o,i,r)=>{if(!o)return;const c=new Map,a=(s,l)=>{var f;const u=(f=c.get(s))!==null&&f!==void 0?f:{incomingCount:0,outgoingCount:0,internalCount:0};return l.incomingCount!=null&&(u.incomingCount+=l.incomingCount),l.outgoingCount!=null&&(u.outgoingCount+=l.outgoingCount),l.internalCount!=null&&(u.internalCount+=l.internalCount),u};for(const s of o)if(this.isFlowInSelection(s,i,r)){const l=this.accessors.getFlowOriginId(s),f=this.accessors.getFlowDestId(s),u=this.accessors.getFlowMagnitude(s);l===f?c.set(l,a(l,{internalCount:u})):(c.set(l,a(l,{outgoingCount:u})),c.set(f,a(f,{incomingCount:u})))}return c}),this.getLocationsTree=w(this.getLocationsForZoom,t=>{if(!!t)return new xt(t,o=>gt(this.accessors.getLocationLon(o)),o=>ht(this.accessors.getLocationLat(o)))}),this._getLocationIdsInViewport=w(this.getLocationsTree,this.getViewportBoundingBox,(t,o)=>{const i=this._getLocationsInBboxIndices(t,o);if(i)return new Set(i.map(r=>t.points[r].id))}),this.getLocationIdsInViewport=me(pe,(t,o,i)=>{if(t===o)return!0;if(t==null||o==null||t.size!==o.size)return!1;for(const r of t)if(!o.has(r))return!1;return!0})(this._getLocationIdsInViewport,t=>{if(!!t)return t}),this.getTotalUnfilteredCount=w(this.getSortedFlowsForKnownLocations,t=>{if(!!t)return t.reduce((o,i)=>o+this.accessors.getFlowMagnitude(i),0)}),this.getTotalFilteredCount=w(this.getSortedAggregatedFilteredFlows,this.getSelectedLocationsSet,this.getLocationFilterMode,(t,o,i)=>t?t.reduce((c,a)=>this.isFlowInSelection(a,o,i)?c+this.accessors.getFlowMagnitude(a):c,0):void 0),this._getLocationTotalsExtent=w(this.getLocationTotals,t=>Yt(t,void 0)),this._getLocationTotalsForViewportExtent=w(this.getLocationTotals,this.getLocationIdsInViewport,(t,o)=>Yt(t,o)),this.getLocationTotalsExtent=(t,o)=>t.settings.adaptiveScalesEnabled?this._getLocationTotalsForViewportExtent(t,o):this._getLocationTotalsExtent(t,o),this.getFlowsForFlowmapLayer=w(this.getSortedAggregatedFilteredFlows,this.getLocationIdsInViewport,this.getSelectedLocationsSet,this.getLocationFilterMode,this.getMaxTopFlowsDisplayNum,(t,o,i,r,c)=>{if(!t||!o)return;const a=[];let s=0;for(const l of t){const f=this.accessors.getFlowOriginId(l),u=this.accessors.getFlowDestId(l);if((o.has(f)||o.has(u))&&this.isFlowInSelection(l,i,r)&&f!==u&&(a.push(l),s++),s>c)break}return a.reverse()}),this._getFlowMagnitudeExtent=w(this.getSortedAggregatedFilteredFlows,this.getSelectedLocationsSet,this.getLocationFilterMode,(t,o,i)=>{if(!t)return;let r;for(const c of t)if(this.accessors.getFlowOriginId(c)!==this.accessors.getFlowDestId(c)&&this.isFlowInSelection(c,o,i)){const a=this.accessors.getFlowMagnitude(c);r==null?r=[a,a]:(a<r[0]&&(r[0]=a),a>r[1]&&(r[1]=a))}return r}),this._getAdaptiveFlowMagnitudeExtent=w(this.getFlowsForFlowmapLayer,t=>{if(!t)return;const o=vt(t,this.accessors.getFlowMagnitude);return o[0]!==void 0&&o[1]!==void 0?o:void 0}),this.getFlowMagnitudeExtent=(t,o)=>t.settings.adaptiveScalesEnabled?this._getAdaptiveFlowMagnitudeExtent(t,o):this._getFlowMagnitudeExtent(t,o),this.getLocationMaxAbsTotalGetter=w(this.getLocationTotals,t=>o=>{const i=t==null?void 0:t.get(o);if(!!i)return Math.max(Math.abs(i.incomingCount+i.internalCount),Math.abs(i.outgoingCount+i.internalCount))}),this.getFlowThicknessScale=w(this.getFlowMagnitudeExtent,Jo),this.getCircleSizeScale=w(this.getMaxLocationCircleSize,this.getLocationTotalsEnabled,this.getLocationTotalsExtent,(t,o,i)=>{if(!o)return()=>t;if(!!i)return Ne().range([0,t]).domain([0,Math.max.apply(null,i.map(r=>Math.abs(r||0)))])}),this.getInCircleSizeGetter=w(this.getCircleSizeScale,this.getLocationTotals,(t,o)=>i=>{const r=o==null?void 0:o.get(i);return r&&t&&t(Math.abs(r.incomingCount+r.internalCount))||0}),this.getOutCircleSizeGetter=w(this.getCircleSizeScale,this.getLocationTotals,(t,o)=>i=>{const r=o==null?void 0:o.get(i);return r&&t&&t(Math.abs(r.outgoingCount+r.internalCount))||0}),this.getSortedLocationsForZoom=w(this.getLocationsForZoom,this.getInCircleSizeGetter,this.getOutCircleSizeGetter,(t,o,i)=>t?[...t].sort((c,a)=>{const s=this.accessors.getLocationId(c),l=this.accessors.getLocationId(a);return Kt(Math.max(o(s),i(s)),Math.max(o(l),i(l)))}):void 0),this.getLocationsForFlowmapLayer=w(this.getSortedLocationsForZoom,t=>t),this.getLocationsForFlowmapLayerById=w(this.getLocationsForFlowmapLayer,t=>{if(!!t)return t.reduce((o,i)=>(o.set(this.accessors.getLocationId(i),i),o),new Map)}),this.getLocationOrClusterByIdGetter=w(this.getClusterIndex,this.getLocationsById,(t,o)=>i=>{var r;return(r=t==null?void 0:t.getClusterById(i))!==null&&r!==void 0?r:o==null?void 0:o.get(i)}),this.getLayersData=w(this.getLocationsForFlowmapLayer,this.getFlowsForFlowmapLayer,this.getFlowmapColorsRGBA,this.getLocationsForFlowmapLayerById,this.getLocationIdsInViewport,this.getInCircleSizeGetter,this.getOutCircleSizeGetter,this.getFlowThicknessScale,this.getAnimate,this.getLocationLabelsEnabled,(t,o,i,r,c,a,s,l,f,u)=>this._prepareLayersData(t,o,i,r,c,a,s,l,f,u)),this.accessors=new Ft(e),this.setAccessors(e)}setAccessors(e){this.accessors=new Ft(e)}getAggregateAccessors(){return this.accessors}prepareLayersData(e,t){const o=this.getLocationsForFlowmapLayer(e,t)||[],i=this.getFlowsForFlowmapLayer(e,t)||[],r=this.getFlowmapColorsRGBA(e,t),c=this.getLocationsForFlowmapLayerById(e,t),a=this.getLocationIdsInViewport(e,t),s=this.getInCircleSizeGetter(e,t),l=this.getOutCircleSizeGetter(e,t),f=this.getFlowThicknessScale(e,t),u=this.getLocationLabelsEnabled(e,t);return this._prepareLayersData(o,i,r,c,a,s,l,f,e.settings.animationEnabled,u)}_prepareLayersData(e,t,o,i,r,c,a,s,l,f){e||(e=[]),t||(t=[]);const{getFlowOriginId:u,getFlowDestId:d,getFlowMagnitude:g,getLocationId:h,getLocationLon:p,getLocationLat:v,getLocationName:L}=this.accessors,E=vt(t,x=>g(x)),D=Fo(o,E,!1),y=Float32Array.from(function*(){for(const x of e)yield p(x),yield v(x)}()),b=de(o)?o.positive.locationCircles.inner:o.locationCircles.inner,_=Uint8Array.from(function*(){for(const x of e)yield*b}()),m=Float32Array.from(function*(){for(const x of e){const S=h(x);yield r!=null&&r.has(S)?c(S):1}}()),C=Float32Array.from(function*(){for(const x of e){const S=h(x);yield r!=null&&r.has(S)?a(S):1}}()),O=Float32Array.from(function*(){for(const x of t){const S=i==null?void 0:i.get(u(x));yield S?p(S):0,yield S?v(S):0}}()),T=Float32Array.from(function*(){for(const x of t){const S=i==null?void 0:i.get(d(x));yield S?p(S):0,yield S?v(S):0}}()),F=Float32Array.from(function*(){for(const x of t)yield s&&s(g(x))||0}()),M=Float32Array.from(function*(){for(const x of t){const S=u(x),K=d(x);yield Math.max(c(S),a(S)),yield Math.max(c(K),a(K))}}()),A=Uint8Array.from(function*(){for(const x of t)yield*D(g(x))}()),z=l?Float32Array.from(function*(){for(const x of t)yield new En.alea(`${u(x)}-${d(x)}`)()}()):void 0;return Object.assign({circleAttributes:{length:e.length,attributes:{getPosition:{value:y,size:2},getColor:{value:_,size:4},getInRadius:{value:m,size:1},getOutRadius:{value:C,size:1}}},lineAttributes:{length:t.length,attributes:Object.assign({getSourcePosition:{value:O,size:2},getTargetPosition:{value:T,size:2},getThickness:{value:F,size:1},getColor:{value:A,size:4},getEndpointOffsets:{value:M,size:2}},z?{getStaggering:{value:z,size:1}}:{})}},f?{locationLabels:e.map(L)}:void 0)}getLocationsInBbox(e,t){if(!!e)return this._getLocationsInBboxIndices(e,t).map(o=>e.points[o])}_getLocationsInBboxIndices(e,t){if(!e)return;const[o,i,r,c]=t,[a,s,l,f]=[gt(o),ht(i),gt(r),ht(c)];return e.range(Math.min(a,l),Math.min(s,f),Math.max(a,l),Math.max(s,f))}isFlowInSelection(e,t,o){const i=this.accessors.getFlowOriginId(e),r=this.accessors.getFlowDestId(e);if(t)switch(o){case W.ALL:return t.has(i)||t.has(r);case W.BETWEEN:return t.has(i)&&t.has(r);case W.INCOMING:return t.has(r);case W.OUTGOING:return t.has(i)}return!0}}function Yt(n,e){if(!n)return;let t;for(const[o,{incomingCount:i,outgoingCount:r,internalCount:c}]of n.entries())if(e==null||e.has(o)){const a=Math.min(i+c,r+c,c),s=Math.max(i+c,r+c,c);t?(a<t[0]&&(t[0]=a),s>t[1]&&(t[1]=s)):t=[a,s]}return t}function gt(n){return n/360+.5}function ht(n){const e=Math.sin(n*Math.PI/180),t=.5-.25*Math.log((1+e)/(1-e))/Math.PI;return t<0?0:t>1?1:t}function ui(n,e){const t=Jt(n,i=>{const r=e.getFlowOriginId(i[0]),c=e.getFlowDestId(i[0]);return{aggregate:!0,origin:r,dest:c,count:i.reduce((s,l)=>{const f=e.getFlowMagnitude(l);return f&&!isNaN(f)&&isFinite(f)?s+f:s},0)}},e.getFlowOriginId,e.getFlowDestId),o=[];for(const i of t.values())for(const r of i.values())o.push(r);return o}function pt(n,e){const{getInRadius:t,getOutRadius:o}=n.attributes;return Math.max(t.value[e],o.value[e])}function Zt(n,e){const{getPosition:t}=n.attributes;return[t.value[e*2],t.value[e*2+1]]}function fi(n,e){const{getColor:t,getEndpointOffsets:o,getSourcePosition:i,getTargetPosition:r,getThickness:c,getStaggering:a}=n.attributes;return{length:1,attributes:Object.assign({getColor:{value:t.value.subarray(e*4,(e+1)*4),size:4},getEndpointOffsets:{value:o.value.subarray(e*2,(e+1)*2),size:2},getSourcePosition:{value:i.value.subarray(e*2,(e+1)*2),size:2},getTargetPosition:{value:r.value.subarray(e*2,(e+1)*2),size:2},getThickness:{value:c.value.subarray(e,e+1),size:1}},a?{getStaggering:{value:a.value.subarray(e,e+1),size:1}}:void 0)}}function di(n,e,t){const{pad:o=.05,maxZoom:i=100}=t||{},r=Be(n),[[c,a],[s,l]]=r,f=o?[[c-o*(s-c),a-o*(l-a)],[s+o*(s-c),l+o*(l-a)]]:r,[u,d]=e;return Object.assign(Object.assign({},Ee({width:u,height:d,bounds:f,padding:t==null?void 0:t.padding,maxZoom:i})),{width:u,height:d,bearing:0,pitch:0})}function gi(n,e,t,o){const i=c=>({type:"Point",coordinates:e(c)});let r;if(Array.isArray(n))r=n.map(i);else{r=[];for(const c of n)r.push(i(c))}return di({type:"GeometryCollection",geometries:r},t,o)}function hi(n){return n&&n.locations&&n.flows}function pi(n){return n&&typeof n.setFlowmapState=="function"&&typeof n.getViewportForLocations=="function"&&typeof n.getFlowByIndex=="function"&&typeof n.getLocationById=="function"&&typeof n.getLocationByIndex=="function"&&typeof n.getLayersData=="function"}var G=globalThis&&globalThis.__awaiter||function(n,e,t,o){function i(r){return r instanceof t?r:new t(function(c){c(r)})}return new(t||(t=Promise))(function(r,c){function a(f){try{l(o.next(f))}catch(u){c(u)}}function s(f){try{l(o.throw(f))}catch(u){c(u)}}function l(f){f.done?r(f.value):i(f.value).then(a,s)}l((o=o.apply(n,e||[])).next())})};class mi{constructor(e){this.selectors=new li(e),this.flowmapData=void 0,this.flowmapState=void 0}setAccessors(e){this.selectors.setAccessors(e)}setFlowmapData(e){this.flowmapData=e}getSelectors(){return this.selectors}getFlowmapData(){return this.flowmapData}setFlowmapState(e){return G(this,void 0,void 0,function*(){this.flowmapState=e})}getFlowmapState(){return this.flowmapState}getFlowByIndex(e){return G(this,void 0,void 0,function*(){if(!this.flowmapState||!this.flowmapData)return;const t=this.selectors.getFlowsForFlowmapLayer(this.flowmapState,this.flowmapData);return t==null?void 0:t[e]})}getLocationByIndex(e){return G(this,void 0,void 0,function*(){if(!this.flowmapState||!this.flowmapData)return;const t=this.selectors.getLocationsForFlowmapLayer(this.flowmapState,this.flowmapData);return t==null?void 0:t[e]})}getLayersData(){return G(this,void 0,void 0,function*(){if(!(!this.flowmapState||!this.flowmapData))return this.selectors.getLayersData(this.flowmapState,this.flowmapData)})}getLocationById(e){return G(this,void 0,void 0,function*(){if(!this.flowmapState||!this.flowmapData)return;const t=this.selectors.getClusterIndex(this.flowmapState,this.flowmapData);if(t){const i=t.getClusterById(e);if(i)return i}const o=this.selectors.getLocationsById(this.flowmapState,this.flowmapData);return o==null?void 0:o.get(e)})}getTotalsForLocation(e){var t;return G(this,void 0,void 0,function*(){if(!(!this.flowmapState||!this.flowmapData))return(t=this.selectors.getLocationTotals(this.flowmapState,this.flowmapData))===null||t===void 0?void 0:t.get(e)})}getViewportForLocations(e,t){var o;return G(this,void 0,void 0,function*(){if(!!(!((o=this.flowmapData)===null||o===void 0)&&o.locations))return gi(this.flowmapData.locations,i=>[this.selectors.accessors.getLocationLon(i),this.selectors.accessors.getLocationLat(i)],e,t)})}updateLayersData(e){return G(this,void 0,void 0,function*(){e(yield this.getLayersData())})}getClusterZoom(){return this.flowmapState&&this.flowmapData?this.selectors.getClusterZoom(this.flowmapState,this.flowmapData):void 0}getClusterIndex(){return this.flowmapState&&this.flowmapData?this.selectors.getClusterIndex(this.flowmapState,this.flowmapData):void 0}getLocationsById(){return this.flowmapState&&this.flowmapData?this.selectors.getLocationsById(this.flowmapState,this.flowmapData):void 0}getLocationTotals(){return this.flowmapState&&this.flowmapData?this.selectors.getLocationTotals(this.flowmapState,this.flowmapData):void 0}getFlowsForFlowmapLayer(){return this.flowmapState&&this.flowmapData?this.selectors.getFlowsForFlowmapLayer(this.flowmapState,this.flowmapData):void 0}}var ct;(function(n){n.LOCATION="location",n.FLOW="flow"})(ct||(ct={}));var vi=globalThis&&globalThis.__awaiter||function(n,e,t,o){function i(r){return r instanceof t?r:new t(function(c){c(r)})}return new(t||(t=Promise))(function(r,c){function a(f){try{l(o.next(f))}catch(u){c(u)}}function s(f){try{l(o.throw(f))}catch(u){c(u)}}function l(f){f.done?r(f.value):i(f.value).then(a,s)}l((o=o.apply(n,e||[])).next())})};const yi=["filter","locationTotalsEnabled","locationLabelsEnabled","adaptiveScalesEnabled","animationEnabled","clusteringEnabled","clusteringLevel","fadeEnabled","fadeOpacityEnabled","clusteringAuto","darkMode","fadeAmount","colorScheme","highlightColor","maxTopFlowsDisplayNum"];var q;(function(n){n.LOCATION="location",n.FLOW="flow"})(q||(q={}));class ye extends vn{constructor(e){super(Object.assign(Object.assign({},e),{onHover:(t,o)=>{const i=Date.now();this.setState({highlightedObject:this._getHighlightedObject(t),lastHoverTime:i});const{onHover:r}=e;r&&this._getFlowmapLayerPickingInfo(t).then(c=>{var a,s;((s=(a=this.state)===null||a===void 0?void 0:a.lastHoverTime)!==null&&s!==void 0?s:0)<=i&&(this.setState({pickingInfo:c}),r(c,o))})},onClick:(t,o)=>{const{onClick:i}=e,r=Date.now();this.setState({lastClickTime:r}),i&&this._getFlowmapLayerPickingInfo(t).then(c=>{var a,s;((s=(a=this.state)===null||a===void 0?void 0:a.lastClickTime)!==null&&s!==void 0?s:0)<=r&&(this.setState({pickingInfo:c}),c&&i(c,o))})}}))}initializeState(){this.state={accessors:new Ft(this.props),dataProvider:this._getOrMakeDataProvider(),layersData:void 0,highlightedObject:void 0,pickingInfo:void 0,lastHoverTime:void 0,lastClickTime:void 0}}getPickingInfo({info:e}){var t,o;if(!e.object){const i=(o=(t=this.state)===null||t===void 0?void 0:t.pickingInfo)===null||o===void 0?void 0:o.object;if(i)return Object.assign(Object.assign({},e),{object:i,picked:!0})}return e}_getOrMakeDataProvider(){const{data:e,dataProvider:t}=this.props;if(pi(t))return t;if(hi(e)){const o=new mi(this.props);return o.setFlowmapData(e),o}throw new Error("FlowmapLayer: data must be a FlowmapDataProvider or FlowmapData")}_updateDataProvider(){this.setState({dataProvider:this._getOrMakeDataProvider()})}shouldUpdateState(e){const{changeFlags:t}=e;return t.viewportChanged?!0:super.shouldUpdateState(e)}updateState({oldProps:e,props:t,changeFlags:o}){if(o.propsChanged,o.dataChanged&&this._updateDataProvider(),(o.viewportChanged||o.dataChanged)&&this.setState({highlightedObject:void 0}),o.viewportChanged||o.dataChanged||o.propsChanged&&yi.some(i=>e[i]!==t[i])){const{dataProvider:i}=this.state||{};i&&(i.setFlowmapState(this._getFlowmapState()),i.updateLayersData(r=>{this.setState({layersData:r,highlightedObject:void 0})},o))}}_getSettingsState(){const{locationTotalsEnabled:e,locationLabelsEnabled:t,adaptiveScalesEnabled:o,animationEnabled:i,clusteringEnabled:r,clusteringLevel:c,fadeEnabled:a,fadeOpacityEnabled:s,clusteringAuto:l,darkMode:f,fadeAmount:u,colorScheme:d,highlightColor:g,maxTopFlowsDisplayNum:h}=this.props;return{locationTotalsEnabled:e,locationLabelsEnabled:t,adaptiveScalesEnabled:o,animationEnabled:i,clusteringEnabled:r,clusteringLevel:c,fadeEnabled:a,fadeOpacityEnabled:s,clusteringAuto:l,darkMode:f,fadeAmount:u,colorScheme:d,highlightColor:g,maxTopFlowsDisplayNum:h}}_getFlowmapState(){return{viewport:wi(this.context.viewport),filter:this.props.filter,settings:this._getSettingsState()}}_getFlowmapLayerPickingInfo(e){var t;return vi(this,void 0,void 0,function*(){const{index:o,sourceLayer:i}=e,{dataProvider:r,accessors:c}=this.state||{};if(!r||!c)return;const a=Object.assign(Object.assign({},e),{picked:e.picked,layer:e.layer,index:e.index,x:e.x,y:e.y,coordinate:e.coordinate,event:e.event});if(i instanceof V||i instanceof st){const s=o===-1?void 0:yield r.getFlowByIndex(o);if(s){const l=yield r.getLocationById(c.getFlowOriginId(s)),f=yield r.getLocationById(c.getFlowDestId(s));if(l&&f)return Object.assign(Object.assign({},a),{object:{type:ct.FLOW,flow:s,origin:l,dest:f,count:c.getFlowMagnitude(s)}})}}else if(i instanceof et){const s=o===-1?void 0:yield r.getLocationByIndex(o);if(s){const l=c.getLocationId(s),f=c.getLocationName(s),u=yield r.getTotalsForLocation(l),{circleAttributes:d}=((t=this.state)===null||t===void 0?void 0:t.layersData)||{};if(u&&d){const g=pt(d,e.index);return Object.assign(Object.assign({},a),{object:{type:ct.LOCATION,location:s,id:l,name:f,totals:u,circleRadius:g}})}}}})}_getHighlightedObject(e){var t,o;const{index:i,sourceLayer:r}=e;if(!(i<0)){if(r instanceof V||r instanceof st){const{lineAttributes:c}=((t=this.state)===null||t===void 0?void 0:t.layersData)||{};if(c){let a=fi(c,i);return this.props.fadeOpacityEnabled&&(a=Object.assign(Object.assign({},a),{attributes:Object.assign(Object.assign({},a.attributes),{getColor:Object.assign(Object.assign({},a.attributes.getColor),{value:new Uint8Array([...a.attributes.getColor.value.slice(0,3),255])})})})),{type:q.FLOW,lineAttributes:a}}}else if(r instanceof et){const{circleAttributes:c}=((o=this.state)===null||o===void 0?void 0:o.layersData)||{};if(c)return{type:q.LOCATION,coords:Zt(c,i),radius:pt(c,i)}}}}renderLayers(){var e;const t=[];if(!((e=this.state)===null||e===void 0)&&e.layersData){const{layersData:o,highlightedObject:i}=this.state,{circleAttributes:r,lineAttributes:c,locationLabels:a}=o||{};if(r&&c){const s=Co(this._getSettingsState()),l=N(s.outlineColor||(this.props.darkMode?"#000":"#fff")),f={data:c,parameters:Object.assign(Object.assign({},this.props.parameters),{depthTest:!1})};if(this.props.animationEnabled?t.push(new st(Object.assign({},this.getSubLayerProps(Object.assign(Object.assign({},f),{id:"animated-flow-lines",drawOutline:!1,thicknessUnit:20}))))):t.push(new V(Object.assign({},this.getSubLayerProps(Object.assign(Object.assign({},f),{id:"flow-lines",drawOutline:!0,outlineColor:l}))))),t.push(new et(this.getSubLayerProps({id:"circles",data:r,emptyColor:this.props.darkMode?[0,0,0,255]:[255,255,255,255],outlineEmptyMix:.4}))),i)switch(i.type){case q.LOCATION:t.push(new yn(Object.assign({},this.getSubLayerProps({id:"location-highlight",data:[i],pickable:!1,antialiasing:!0,stroked:!0,filled:!1,lineWidthUnits:"pixels",getLineWidth:2,radiusUnits:"pixels",getRadius:u=>u.radius,getLineColor:N(this.props.highlightColor),getPosition:u=>u.coords}))));break;case q.FLOW:t.push(new V(Object.assign({},this.getSubLayerProps({id:"flow-highlight",data:i.lineAttributes,drawOutline:!0,pickable:!1,outlineColor:N(this.props.highlightColor),outlineThickness:1,parameters:{depthTest:!1}}))));break}}a&&t.push(new wn(this.getSubLayerProps({id:"location-labels",data:a,maxWidth:1e3,pickable:!1,fontFamily:"Helvetica",getPixelOffset:(s,{index:l})=>{const f=pt(r,l);return[0,f+5]},getPosition:(s,{index:l})=>Zt(r,l),getText:s=>s,getSize:10,getColor:[255,255,255,255],getAngle:0,getTextAnchor:"middle",getAlignmentBaseline:"top"})))}return t}}ye.defaultProps={darkMode:!0,fadeAmount:50,locationTotalsEnabled:!0,locationLabelsEnabled:!1,animationEnabled:!1,clusteringEnabled:!0,fadeEnabled:!0,fadeOpacityEnabled:!1,clusteringAuto:!0,clusteringLevel:void 0,adaptiveScalesEnabled:!0,colorScheme:"Teal",highlightColor:"orange",maxTopFlowsDisplayNum:5e3};function wi(n){const{width:e,height:t,longitude:o,latitude:i,zoom:r,pitch:c,bearing:a}=n;return{width:e,height:t,longitude:o,latitude:i,zoom:r,pitch:c,bearing:a}}function bi({props:n={},viewId:e=0}){const{locations:t,flows:o,dark:i,elapsed:r,vizDetails:c}=n,[a,s]=At.exports.useState(Q.state.viewState),[l,f]=At.exports.useState({});ot[e]=()=>{s(Q.state.viewState)};function u(){console.log("click!")}function d(p){console.log(p),f(p)}function g(p){s(p),p.center=[p.longitude,p.latitude],Q.commit("setMapCamera",p)}const h=new ye({data:n,id:"my-flowmap-"+e,getLocationId:p=>p.id,getLocationLat:p=>p.lat,getLocationLon:p=>p.lon,getLocationName:p=>p.id,getFlowOriginId:p=>p.o,getFlowDestId:p=>p.d,getFlowMagnitude:p=>p.v||null,adaptiveScalesEnabled:!0,animationEnabled:c.animationEnabled,clusteringEnabled:c.clustering,clusteringAuto:c.clustering,clusteringLevel:c.clusteringLevel,colorScheme:c.colorScheme,darkMode:i,drawOutline:!1,fadeEnabled:!0,fadeAmount:20,fadeOpacityEnabled:!0,locationLabelsEnabled:c.locationLabelsEnabled,locationTotalsEnabled:c.locationTotalsEnabled,onHover:d,opacity:1,outlineThickness:c.outlineThickness,pickable:!0});return Pt.createElement(Se,{layers:[h],controller:!0,viewState:a,pickingRadius:4,getCursor:()=>"pointer",onClick:u,onViewStateChange:p=>g(p.viewState)},Pt.createElement(Oe,{mapStyle:Q.getters.mapStyle,mapboxApiAccessToken:we}))}var Li=Object.defineProperty,Ci=Object.getOwnPropertyDescriptor,B=(n,e,t,o)=>{for(var i=o>1?void 0:o?Ci(e,t):e,r=n.length-1,c;r>=0;r--)(c=n[r])&&(i=(o?c(e,t,i):c(i))||i);return o&&i&&Li(e,t,i),i};rt.use(be);let R=class extends rt{constructor(){super(...arguments),this.boundaries=[],this.centroids=[],this.flows=[],this.viewId=Math.floor(1e12*Math.random()),this.statusText="Loading...",this.needsInitialMapExtent=!0,this.vizDetails={title:"",description:"",thumbnail:"",zoom:9,center:null,pitch:0,bearing:0,boundaries:"",boundariesJoinCol:"",boundariesLabels:"",boundariesLabel:"",dataset:"",origin:"",destination:"",flow:"",colorScheme:"Teal",highlightColor:"orange",fadeEnabled:!0,fadeAmount:50,animationEnabled:!0,clustering:!0,clusteringLevel:null,locationLabelsEnabled:!0,locationTotalsEnabled:!0,pickable:!0,opacity:null,fadeOpacityEnabled:!0,outlineThickness:0,showOnlyTopFlows:null,maxTopFlowsDisplayNum:null},this.myState={statusMessage:"",fileApi:void 0,fileSystem:void 0,subfolder:"",yamlConfig:"",thumbnail:!1},this.startTime=Date.now(),this.elapsed=0,this.animator=null,this.thumbnailUrl="url('assets/thumbnail.jpg') no-repeat;"}get mapProps(){return{locations:this.centroids,flows:this.flows,dark:this.$store.state.isDarkMode,elapsed:this.elapsed,vizDetails:this.vizDetails}}viewMoved(){!ot[this.viewId]||ot[this.viewId]()}async mounted(){try{if(this.$store.commit("setFullScreen",!this.thumbnail),this.myState.thumbnail=this.thumbnail,this.myState.yamlConfig=this.yamlConfig,this.buildFileApi(),this.myDataManager=this.datamanager||new mn(this.root,this.subfolder),await this.getVizDetails(),this.thumbnail){this.buildThumbnail();return}this.needsInitialMapExtent&&(this.vizDetails.center||this.vizDetails.zoom)&&(this.$store.commit("setMapCamera",{center:this.vizDetails.center,zoom:this.vizDetails.zoom||9,bearing:this.vizDetails.bearing||0,pitch:this.vizDetails.pitch||0,longitude:this.vizDetails.center?this.vizDetails.center[0]:0,latitude:this.vizDetails.center?this.vizDetails.center[1]:0}),this.needsInitialMapExtent=!1),await this.loadBoundaries(),await this.loadDataset(),this.updateChart(),this.$emit("isLoaded"),this.vizDetails=Object.assign({},this.vizDetails),this.statusText=""}catch(n){this.$store.commit("error","Flowmap"+n)}}beforeDestroy(){this.animator&&window.cancelAnimationFrame(this.animator),delete ot[this.viewId]}buildFileApi(){const n=this.fsConfig||this.getFileSystem(this.root);this.fileApi=new bn(n,Q),this.fileSystemConfig=n}get urlThumbnail(){return this.thumbnailUrl}async getVizDetails(){if(this.configFromDashboard){console.log("we have a dashboard"),this.validateYAML(),this.vizDetails=Object.assign({},this.configFromDashboard);return}new RegExp(".*(yml|yaml)$").test(this.myState.yamlConfig)&&(console.log("has yaml"),await this.loadStandaloneYAMLConfig())}async buildThumbnail(){if(!!this.myState.fileApi&&this.thumbnail&&this.vizDetails.thumbnail)try{const e=await(await this.myState.fileApi.getFileBlob(this.myState.subfolder+"/"+this.vizDetails.thumbnail)).arrayBuffer(),t=Ln.arrayBufferToBase64(e);t&&(this.thumbnailUrl=`center / cover no-repeat url(data:image/png;base64,${t})`)}catch(n){console.error(n)}}async validateYAML(){}async loadStandaloneYAMLConfig(){if(!this.fileApi)return{};const n=this.yamlConfig.indexOf("/")>-1?this.yamlConfig:this.subfolder+"/"+this.yamlConfig;try{const t=await this.fileApi.getFileText(n);this.vizDetails=Object.assign({},zt.parse(t));return}catch(t){const o=""+t;o.startsWith("YAMLSemantic")&&this.$store.commit("error",`${n}: ${o}`),console.log(`${n} not found, trying config folders`)}const{vizes:e}=await this.fileApi.findAllYamlConfigs(this.subfolder);if(e[this.yamlConfig])try{const t=await this.fileApi.getFileText(e[this.yamlConfig]);this.vizDetails=Object.assign({},zt.parse(t))}catch{console.error(`Also failed to load ${e[this.yamlConfig]}`)}}async loadBoundaries(){try{if(this.vizDetails.boundaries.startsWith("http")){console.log("in http");const n=await fetch(this.vizDetails.boundaries).then(async e=>await e.json());this.boundaries=n.features}else{const n=`${this.subfolder}/${this.vizDetails.boundaries}`,e=await this.fileApi.getFileJson(`${this.subfolder}/${this.vizDetails.boundaries}`);this.boundaries=e.features}}catch(n){console.error(n);return}this.calculateCentroids(),this.setMapCenter()}calculateCentroids(){const n=this.vizDetails.boundariesLabels||this.vizDetails.boundariesLabel;for(const e of this.boundaries){const t=Ce(e);e.properties[n]&&(t.properties.label=e.properties[n]),t.properties.id=""+e.properties[this.vizDetails.boundariesJoinCol],this.centroids.push({id:`${t.properties.id}`,lon:t.geometry.coordinates[0],lat:t.geometry.coordinates[1]})}console.log({centroids:this.centroids})}async setMapCenter(){if(this.vizDetails.center){typeof this.vizDetails.center=="string"&&(this.vizDetails.center=this.vizDetails.center.split(",").map(Number)),this.$store.commit("setMapCamera",{longitude:this.vizDetails.center[0],latitude:this.vizDetails.center[1],bearing:0,pitch:0,zoom:this.vizDetails.zoom||10,jump:!1});return}if(!this.centroids.length)return;let n=0,e=0,t=0;const o=this.centroids.length,i=256;for(let c=0;c<o;c+=i)e+=this.centroids[c].lon,t+=this.centroids[c].lat,n++;e=e/n,t=t/n;const r=this.$store.state.viewState;e&&t&&this.$store.commit("setMapCamera",{longitude:e,latitude:t,bearing:r.bearing,pitch:r.pitch,zoom:this.vizDetails.zoom||r.zoom,jump:!1})}getFileSystem(n){const e=this.$store.state.svnProjects.filter(t=>t.slug===n);if(e.length===0)throw console.log("no such project"),Error;return e[0]}async loadDataset(){try{const n=await this.myDataManager.getDataset(this.vizDetails);console.log("dataset:",n);const e=n.allRows||{};console.log("data:",e);const t=e.origin.values,o=e.destination.values,i=e.count.values;console.log("in loadDataset");const r=[];for(let c=0;c<t.length;c++)r.push({o:`${t[c]}`,d:`${o[c]}`,v:i[c]});this.flows=r}catch(n){const e=""+n;console.log(e),this.flows=[]}console.log({flows:this.flows})}updateChart(){}};B([U({required:!1})],R.prototype,"fsConfig",2);B([U({required:!0})],R.prototype,"root",2);B([U({required:!1})],R.prototype,"configFromDashboard",2);B([U({required:!1})],R.prototype,"thumbnail",2);B([U({required:!0})],R.prototype,"subfolder",2);B([U({required:!1})],R.prototype,"files",2);B([U({required:!1})],R.prototype,"yamlConfig",2);B([U({required:!1})],R.prototype,"datamanager",2);B([Hn("$store.state.viewState")],R.prototype,"viewMoved",1);R=B([ae({components:{FlowMapLayer:bi,VizConfigurator:xe,ZoomButtons:Fe}})],R);var xi=function(){var n=this,e=n.$createElement,t=n._self._c||e;return t("div",{staticClass:"flowmap",class:{"hide-thumbnail":!n.thumbnail},style:{background:n.urlThumbnail},attrs:{oncontextmenu:"return false"}},[t("div",{staticClass:"map-layout"},[n.centroids.length?t("flow-map-layer",{staticClass:"map-layer",attrs:{viewId:n.viewId,props:n.mapProps}}):n._e()],1),n.vizDetails.title&&!n.thumbnail&&!n.configFromDashboard?t("div",{staticClass:"title-panel"},[t("h3",[n._v(n._s(n.vizDetails.title))]),t("p",[n._v(n._s(n.vizDetails.description))])]):n._e(),n.thumbnail?n._e():t("zoom-buttons"),n.thumbnail?n._e():t("div",{staticClass:"bottom-panel"},[t("b-checkbox",{staticClass:"hello",model:{value:n.vizDetails.animationEnabled,callback:function(o){n.$set(n.vizDetails,"animationEnabled",o)},expression:"vizDetails.animationEnabled"}}),t("p",[n._v("Animation")]),t("b-checkbox",{staticClass:"hello",model:{value:n.vizDetails.locationLabelsEnabled,callback:function(o){n.$set(n.vizDetails,"locationLabelsEnabled",o)},expression:"vizDetails.locationLabelsEnabled"}}),t("p",[n._v("Labels")]),t("b-checkbox",{staticClass:"hello",model:{value:n.vizDetails.clustering,callback:function(o){n.$set(n.vizDetails,"clustering",o)},expression:"vizDetails.clustering"}}),t("p",[n._v("Clustering")])],1)],1)},Fi=[];const Vt={};var _i=Le(R,xi,Fi,!1,Si,"41dc21b0",null,null);function Si(n){for(let e in Vt)this[e]=Vt[e]}var Oi=function(){return _i.exports}(),Zi=Object.freeze(Object.defineProperty({__proto__:null,default:Oi},Symbol.toStringTag,{value:"Module"}));export{ae as C,Oi as F,U as P,Zi as a};
//# sourceMappingURL=Flowmap.cdbb8149.js.map
