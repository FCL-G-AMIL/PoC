{"version":3,"file":"TopSheet.f44901df.js","sources":["../../src/components/TopSheet/TopSheet.vue","../../src/components/TopSheet/TopSheet.vue?vue&type=template&lang.js"],"sourcesContent":["<template lang=\"pug\">\r\n.topsheet.curate-content\r\n  h3.curate-heading(v-if=\"title\")  {{ title }}\r\n\r\n  .output-table(v-if=\"entries.length\")\r\n    .row(v-for=\"row,i in entries\" :key=\"'entry'+i\")\r\n      .cell.top-label(:style=\"row.style\") {{ row.title }}\r\n      b-input.b-input-tight.cell.top-value(\r\n        v-model=\"row.value\"\r\n        :style=\"row.style\"\r\n        @input=\"boxChanged\"\r\n      )\r\n\r\n  .output-table(v-if=\"table.length\" style=\"margin-top: 1rem\")\r\n    .row(v-for=\"row,i in table\" :key=\"'row'+i\")\r\n      .cell.top-label(:style=\"row.style\") {{ row.title }}\r\n      .cell.top-value(:style=\"row.style\") {{ formattedValue(row.value) }}\r\n\r\n</template>\r\n\r\n<script lang=\"ts\">\r\nimport { defineComponent } from 'vue'\r\nimport type { PropType } from 'vue'\r\n\r\nimport { FileSystemConfig, YamlConfigs } from '@/Globals'\r\n\r\nimport TopSheetWorker from './TopSheetWorker.worker.ts?worker'\r\nimport globalStore from '@/store'\r\n\r\nexport type TableRow = {\r\n  title: string\r\n  value: any\r\n  style?: any\r\n}\r\n\r\nexport default defineComponent({\r\n  name: 'TopSheet',\r\n  props: {\r\n    fileSystemConfig: { type: Object as PropType<FileSystemConfig>, required: true },\r\n    subfolder: { type: String, required: true },\r\n    files: { type: Array as PropType<string[]>, required: true },\r\n    yaml: { type: String, required: true },\r\n    allConfigFiles: { type: Object as PropType<YamlConfigs>, required: true },\r\n    cardId: String,\r\n  },\r\n  data: () => {\r\n    return {\r\n      globalState: globalStore.state,\r\n      solverThread: null as any,\r\n      table: [] as TableRow[],\r\n      entries: [] as { key: string; title: string; value: any }[],\r\n      title: '',\r\n    }\r\n  },\r\n  mounted() {\r\n    if (this.files.length) this.runTopSheet()\r\n  },\r\n\r\n  beforeDestroy() {\r\n    try {\r\n      if (this.solverThread) {\r\n        this.solverThread.terminate()\r\n        this.solverThread = null\r\n      }\r\n    } catch (e) {\r\n      console.warn(e)\r\n    }\r\n  },\r\n  watch: {\r\n    'globalState.locale'() {\r\n      if (this.solverThread) {\r\n        this.solverThread.postMessage({\r\n          command: 'updateCalculations',\r\n          entries: this.entries,\r\n          locale: this.globalState.locale,\r\n        })\r\n      }\r\n    },\r\n  },\r\n  methods: {\r\n    formattedValue(value: any) {\r\n      if (!isNaN(value)) return value.toLocaleString([this.$store.state.locale, 'en'])\r\n      if (value === undefined) return '-?-'\r\n      return value\r\n    },\r\n\r\n    async boxChanged() {\r\n      console.log('changed!')\r\n      if (this.solverThread) {\r\n        this.solverThread.postMessage({\r\n          command: 'updateCalculations',\r\n          entries: this.entries,\r\n          locale: this.globalState.locale,\r\n        })\r\n      }\r\n    },\r\n\r\n    async runTopSheet() {\r\n      if (!this.files.length) return\r\n\r\n      try {\r\n        if (!this.solverThread) {\r\n          console.log('spawning topsheet thread')\r\n          this.solverThread = new TopSheetWorker()\r\n          this.solverThread.onmessage = (message: MessageEvent) => {\r\n            this.processWorkerMessage(message)\r\n          }\r\n        }\r\n\r\n        this.solverThread.postMessage({\r\n          command: 'runTopSheet',\r\n          fileSystemConfig: this.fileSystemConfig,\r\n          subfolder: this.subfolder,\r\n          files: this.files,\r\n          yaml: this.yaml,\r\n          locale: this.$store.state.locale,\r\n          allConfigFiles: this.allConfigFiles,\r\n        })\r\n      } catch (e) {\r\n        const message = '' + e\r\n        console.log(message)\r\n        this.table = []\r\n        // this.table = [{ title: message, value: '', style: { backgroundColor: 'yellow' } }]\r\n      }\r\n    },\r\n\r\n    processWorkerMessage(message: MessageEvent) {\r\n      const data = message.data\r\n      switch (data.response) {\r\n        case 'title':\r\n          if (this.cardId) this.$emit('titles', data.title)\r\n          else this.title = data.title\r\n          break\r\n        case 'entries':\r\n          this.entries = data.entryFields\r\n          break\r\n        case 'results':\r\n          this.table = data.results\r\n          this.$emit('isLoaded')\r\n          break\r\n        case 'error':\r\n          this.$store.commit('error', `${this.yaml}: ${data.message}`)\r\n          this.$emit('isLoaded')\r\n          break\r\n        default:\r\n          // shouldn't be here\r\n          this.$emit('isLoaded')\r\n          console.error(data)\r\n      }\r\n    },\r\n  },\r\n})\r\n</script>\r\n\r\n<style scoped lang=\"scss\">\r\n@import '@/styles.scss';\r\n\r\nh3.curate-heading {\r\n  font-size: 1.6rem;\r\n  font-weight: bold;\r\n  color: var(--textFancy);\r\n  padding-top: 0.5rem;\r\n  margin-top: 0rem;\r\n  margin-bottom: 0.5rem;\r\n  border-bottom: 1px dotted var(--textFancy);\r\n}\r\n\r\n.curate-content {\r\n  padding: 1rem 0rem;\r\n  margin: 0rem 0rem;\r\n}\r\n\r\n.output-table {\r\n  width: 100%;\r\n  display: table;\r\n}\r\n\r\n.row {\r\n  display: table-row;\r\n}\r\n\r\n.cell {\r\n  padding-right: 1rem;\r\n  display: table-cell;\r\n  font-size: 1.1rem;\r\n  line-height: 1.2rem;\r\n  padding-bottom: 0.4rem;\r\n}\r\n\r\n// .top-label {\r\n// }\r\n\r\n.top-value {\r\n  text-align: right;\r\n  font-weight: bold;\r\n  // word-break: break-all;\r\n}\r\n</style>\r\n","\r\n.topsheet.curate-content\r\n  h3.curate-heading(v-if=\"title\")  {{ title }}\r\n\r\n  .output-table(v-if=\"entries.length\")\r\n    .row(v-for=\"row,i in entries\" :key=\"'entry'+i\")\r\n      .cell.top-label(:style=\"row.style\") {{ row.title }}\r\n      b-input.b-input-tight.cell.top-value(\r\n        v-model=\"row.value\"\r\n        :style=\"row.style\"\r\n        @input=\"boxChanged\"\r\n      )\r\n\r\n  .output-table(v-if=\"table.length\" style=\"margin-top: 1rem\")\r\n    .row(v-for=\"row,i in table\" :key=\"'row'+i\")\r\n      .cell.top-label(:style=\"row.style\") {{ row.title }}\r\n      .cell.top-value(:style=\"row.style\") {{ formattedValue(row.value) }}\r\n\r\n"],"names":["__vue2_script","defineComponent","globalStore","value","TopSheetWorker","message","data","render","_vm","_h","_c","row","i","$$v","staticRenderFns"],"mappings":"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"}